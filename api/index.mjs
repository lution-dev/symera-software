var Je=Object.defineProperty;var Ke=(d,a)=>()=>(d&&(a=d(d=0)),a);var We=(d,a)=>{for(var o in a)Je(d,o,{get:a[o],enumerable:!0})};var be={};We(be,{activityLogs:()=>q,budgetItems:()=>M,documents:()=>B,documentsRelations:()=>Ge,eventFeedbacks:()=>U,eventFeedbacksRelations:()=>Ze,eventFormSchema:()=>ye,eventTeamMembers:()=>P,events:()=>b,eventsRelations:()=>ct,expenseFormSchema:()=>ot,expenses:()=>L,feedbackMetrics:()=>Q,feedbackMetricsRelations:()=>Xe,insertBudgetItemSchema:()=>nt,insertDocumentSchema:()=>De,insertEventActivitySchema:()=>tt,insertEventFeedbackSchema:()=>rt,insertEventSchema:()=>qe,insertExpenseSchema:()=>se,insertFeedbackMetricsSchema:()=>it,insertParticipantSchema:()=>pe,insertScheduleItemSchema:()=>he,insertTaskAssigneeSchema:()=>et,insertTaskSchema:()=>ke,insertTeamMemberSchema:()=>st,insertUserSchema:()=>Qe,insertVendorSchema:()=>at,participants:()=>O,participantsRelations:()=>Ye,scheduleItems:()=>T,scheduleItemsRelations:()=>He,taskAssignees:()=>R,tasks:()=>x,users:()=>j,vendors:()=>V});import{relations as de}from"drizzle-orm";import{text as A,integer as F,pgTable as K,timestamp as N,boolean as Ae,serial as H}from"drizzle-orm/pg-core";import{createInsertSchema as W}from"drizzle-zod";import{z as _}from"zod";var j,b,x,R,q,P,V,M,L,T,B,O,U,Q,He,Ge,Ye,Ze,Xe,Qe,qe,ye,ke,et,tt,st,at,he,nt,se,ot,De,pe,rt,it,ct,oe=Ke(()=>{"use strict";j=K("users",{id:A("id").primaryKey(),email:A("email").notNull().unique(),firstName:A("first_name").notNull(),lastName:A("last_name").notNull(),phone:A("phone"),profileImageUrl:A("profile_image_url"),createdAt:N("created_at").defaultNow().notNull(),updatedAt:N("updated_at").defaultNow().notNull()}),b=K("events",{id:H("id").primaryKey(),name:A("name").notNull(),type:A("type").notNull(),format:A("format").notNull(),startDate:N("start_date").notNull(),endDate:N("end_date"),startTime:A("start_time"),endTime:A("end_time"),location:A("location"),meetingUrl:A("meeting_url"),description:A("description"),budget:F("budget"),expenses:F("expenses").default(0),attendees:F("attendees"),coverImageUrl:A("cover_image_url"),status:A("status").default("planning"),feedbackUrl:A("feedback_url"),ownerId:A("owner_id").references(()=>j.id).notNull(),createdAt:N("created_at").defaultNow().notNull(),updatedAt:N("updated_at").defaultNow().notNull()}),x=K("tasks",{id:H("id").primaryKey(),title:A("title").notNull(),description:A("description"),dueDate:N("due_date"),status:A("status").default("todo").notNull(),priority:A("priority").default("medium").notNull(),eventId:F("event_id").references(()=>b.id).notNull(),assigneeId:A("assignee_id").references(()=>j.id),createdAt:N("created_at").defaultNow().notNull(),updatedAt:N("updated_at").defaultNow().notNull()}),R=K("task_assignees",{id:H("id").primaryKey(),taskId:F("task_id").references(()=>x.id).notNull(),userId:A("user_id").references(()=>j.id).notNull(),createdAt:N("created_at").defaultNow().notNull()}),q=K("activity_logs",{id:H("id").primaryKey(),eventId:F("event_id").references(()=>b.id).notNull(),userId:A("user_id").references(()=>j.id).notNull(),action:A("action").notNull(),details:A("details"),createdAt:N("created_at").defaultNow().notNull()}),P=K("event_team_members",{id:H("id").primaryKey(),eventId:F("event_id").references(()=>b.id).notNull(),userId:A("user_id").references(()=>j.id).notNull(),role:A("role").notNull(),permissions:A("permissions"),createdAt:N("created_at").defaultNow().notNull()}),V=K("vendors",{id:H("id").primaryKey(),name:A("name").notNull(),contactName:A("contact_name"),contactEmail:A("contact_email"),contactPhone:A("contact_phone"),service:A("service").notNull(),cost:F("cost"),notes:A("notes"),eventId:F("event_id").references(()=>b.id).notNull(),createdAt:N("created_at").defaultNow().notNull(),updatedAt:N("updated_at").defaultNow().notNull()}),M=K("budget_items",{id:H("id").primaryKey(),eventId:F("event_id").references(()=>b.id).notNull(),name:A("name").notNull(),amount:F("amount").notNull(),category:A("category"),dueDate:N("due_date"),paid:Ae("paid").default(!1),notes:A("notes"),createdAt:N("created_at").defaultNow().notNull(),updatedAt:N("updated_at").defaultNow().notNull()}),L=K("expenses",{id:H("id").primaryKey(),eventId:F("event_id").references(()=>b.id).notNull(),name:A("name").notNull(),amount:F("amount").notNull(),category:A("category"),dueDate:N("due_date"),paymentDate:N("payment_date"),paid:Ae("paid").default(!1),notes:A("notes"),vendorId:F("vendor_id").references(()=>V.id),createdAt:N("created_at").defaultNow().notNull(),updatedAt:N("updated_at").defaultNow().notNull()}),T=K("schedule_items",{id:H("id").primaryKey(),eventId:F("event_id").references(()=>b.id).notNull(),title:A("title").notNull(),description:A("description"),eventDate:N("event_date"),startTime:A("start_time").notNull(),location:A("location"),responsibles:A("responsibles"),createdAt:N("created_at").defaultNow().notNull(),updatedAt:N("updated_at").defaultNow().notNull()}),B=K("documents",{id:H("id").primaryKey(),eventId:F("event_id").references(()=>b.id).notNull(),name:A("name").notNull(),category:A("category").notNull(),description:A("description"),fileUrl:A("file_url").notNull(),fileType:A("file_type").notNull(),uploadedById:A("uploaded_by_id").references(()=>j.id).notNull(),uploadedAt:N("uploaded_at").defaultNow().notNull(),createdAt:N("created_at").defaultNow().notNull(),updatedAt:N("updated_at").defaultNow().notNull()}),O=K("participants",{id:H("id").primaryKey(),eventId:F("event_id").references(()=>b.id).notNull(),name:A("name").notNull(),email:A("email"),phone:A("phone"),status:A("status").default("pending").notNull(),origin:A("origin").default("manual").notNull(),createdAt:N("created_at").defaultNow().notNull(),updatedAt:N("updated_at").defaultNow().notNull()}),U=K("event_feedbacks",{id:H("id").primaryKey(),eventId:F("event_id").references(()=>b.id).notNull(),feedbackId:A("feedback_id").notNull().unique(),name:A("name"),email:A("email"),rating:F("rating").notNull(),comment:A("comment").notNull(),isAnonymous:Ae("is_anonymous").default(!0).notNull(),createdAt:N("created_at").defaultNow().notNull()}),Q=K("feedback_metrics",{id:H("id").primaryKey(),feedbackId:A("feedback_id").references(()=>U.feedbackId).notNull(),viewedAt:N("viewed_at"),submittedAt:N("submitted_at"),ipAddress:A("ip_address"),userAgent:A("user_agent"),createdAt:N("created_at").defaultNow().notNull()}),He=de(T,({one:d})=>({event:d(b,{fields:[T.eventId],references:[b.id]})})),Ge=de(B,({one:d})=>({event:d(b,{fields:[B.eventId],references:[b.id]}),uploadedBy:d(j,{fields:[B.uploadedById],references:[j.id]})})),Ye=de(O,({one:d})=>({event:d(b,{fields:[O.eventId],references:[b.id]})})),Ze=de(U,({one:d,many:a})=>({event:d(b,{fields:[U.eventId],references:[b.id]}),metrics:a(Q)})),Xe=de(Q,({one:d})=>({feedback:d(U,{fields:[Q.feedbackId],references:[U.feedbackId]})})),Qe=W(j).omit({createdAt:!0,updatedAt:!0}),qe=W(b).omit({id:!0,createdAt:!0,updatedAt:!0}),ye=_.object({name:_.string().min(1,"Nome \xE9 obrigat\xF3rio"),type:_.string().min(1,"Tipo \xE9 obrigat\xF3rio"),format:_.string().min(1,"Formato \xE9 obrigat\xF3rio"),startDate:_.string().min(1,"Data de in\xEDcio \xE9 obrigat\xF3ria"),endDate:_.string().optional(),startTime:_.string().optional(),endTime:_.string().optional(),location:_.string().optional(),meetingUrl:_.string().optional(),description:_.string().optional(),budget:_.number().optional(),attendees:_.number().optional(),coverImageUrl:_.string().optional(),status:_.string().optional(),feedbackUrl:_.string().optional(),generateAIChecklist:_.boolean().optional()}),ke=W(x).omit({id:!0,createdAt:!0,updatedAt:!0}),et=W(R).omit({id:!0,createdAt:!0}),tt=W(q).omit({id:!0,createdAt:!0}),st=W(P).omit({id:!0,createdAt:!0}),at=W(V).omit({id:!0,createdAt:!0,updatedAt:!0}),he=W(T).omit({id:!0,createdAt:!0,updatedAt:!0}),nt=W(M).omit({id:!0,createdAt:!0,updatedAt:!0}),se=W(L).omit({id:!0,createdAt:!0,updatedAt:!0}),ot=se.extend({dueDate:_.string().optional(),paymentDate:_.string().optional()}),De=W(B).omit({id:!0,createdAt:!0,updatedAt:!0,uploadedAt:!0}),pe=W(O).omit({id:!0,createdAt:!0,updatedAt:!0}),rt=W(U).omit({id:!0,createdAt:!0}),it=W(Q).omit({id:!0,createdAt:!0}),ct=de(b,({one:d,many:a})=>({owner:d(j,{fields:[b.ownerId],references:[j.id]}),tasks:a(x),teamMembers:a(P),activities:a(q),scheduleItems:a(T),budgetItems:a(M),expenses:a(L),documents:a(B),participants:a(O),feedbacks:a(U)}))});import xe from"express";import{createServer as ht}from"http";import bt from"express";import ne from"path";import Ee from"multer";import Z from"fs";oe();oe();import{Pool as dt}from"pg";import{drizzle as ut}from"drizzle-orm/node-postgres";if(!process.env.DATABASE_URL)throw new Error("DATABASE_URL must be set. Did you forget to provision a database?");var lt=new dt({connectionString:process.env.DATABASE_URL,max:10,idleTimeoutMillis:3e4,connectionTimeoutMillis:5e3,ssl:{rejectUnauthorized:!1}}),g=ut(lt,{schema:be});async function D(d,a=3,o=1e3){let u;for(let m=0;m<=a;m++)try{return await d()}catch(y){if(u=y,y.message?.includes("rate limit")||y.message?.includes("Control plane request failed")){if(m<a){console.log(`Retrying database operation after error: ${y.message}`),await new Promise(s=>setTimeout(s,o*Math.pow(2,m)));continue}}else break}throw u}import{eq as I,and as X,desc as te,sql as ge,isNotNull as mt}from"drizzle-orm";var re=class{constructor(a=6e4){}get(a){}set(a,o){}invalidate(a){}},J=new re(3e5),G=new re(18e4),C=new re(12e4),z=new re(12e4),Y=new re(12e4),Ue=class{async getUser(a){let o=`user:${a}`,u=J.get(o);return u||D(async()=>{let[m]=await g.select().from(j).where(I(j.id,a));return m&&J.set(o,m),m})}async getAllUsers(){let a="all:users",o=J.get(a);return o||D(async()=>{let u=await g.select().from(j);return J.set(a,u),u})}async getUserByEmail(a){let o=`user:email:${a}`,u=J.get(o);return u||D(async()=>{let[m]=await g.select().from(j).where(ge`lower(${j.email}) = lower(${a})`);return m&&(J.set(o,m),J.set(`user:${m.id}`,m)),m})}async upsertUser(a){return D(async()=>{let[o]=await g.insert(j).values(a).onConflictDoUpdate({target:j.id,set:{...a,updatedAt:new Date}}).returning();return J.invalidate(`user:${o.id}`),J.set(`user:${o.id}`,o),o})}async findOrCreateUserByEmail(a,o,u){let m=`user:email:${a}`,y=J.get(m);return y||D(async()=>{let s=await g.select().from(j).where(ge`lower(${j.email}) = lower(${a})`);if(s.length>0){let i=s[0];return J.set(`user:${i.id}`,i),J.set(m,i),i}let t=o?o.trim().split(" "):a.split("@")[0].split("."),e=t[0]||a.split("@")[0],n=t.length>1?t.slice(1).join(" "):"",[r]=await g.insert(j).values({id:`local-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,email:a,firstName:e,lastName:n||"",phone:u||void 0,createdAt:new Date,updatedAt:new Date}).returning();return J.set(`user:${r.id}`,r),J.set(m,r),r})}async migrateUserFromLocalToReplit(a,o){console.log(`[MIGRATION BLOCKED] Tentativa de migrar ${a} para ${o} bloqueada por seguran\xE7a.`)}async getEventsByUser(a){let o=`events:user:${a}`,u=G.get(o);return u||D(async()=>{let m=await g.select().from(b).where(I(b.ownerId,a)).orderBy(te(b.startDate)),s=(await g.select({eventId:P.eventId}).from(P).where(I(P.userId,a))).map(i=>i.eventId);if(s.length===0){let i=await Promise.all(m.map(async l=>{let p=await this.getTeamMembersByEventId(l.id),v=await this.getTasksByEventId(l.id);return{...l,team:p,tasks:v}}));return G.set(o,i),i}let t=[];s.length>0&&(s.length===1?t=await g.select().from(b).where(I(b.id,s[0])):t=(await Promise.all(s.map(l=>g.select().from(b).where(I(b.id,l))))).flat());let e=[...m];for(let i of t)i&&!e.some(l=>l.id===i.id)&&e.push(i);let n=e.sort((i,l)=>{let p=i.startDate,v=l.startDate;return new Date(v).getTime()-new Date(p).getTime()}),r=await Promise.all(n.map(async i=>{let l=await this.getTeamMembersByEventId(i.id),p=await this.getTasksByEventId(i.id);return{...i,team:l,tasks:p}}));return G.set(o,r),r})}async getEventById(a){return D(async()=>{let[o]=await g.select().from(b).where(I(b.id,a));return console.log(`Evento ${a} recuperado diretamente do banco:`,o),o})}async createEvent(a){return D(async()=>{let[o]=await g.insert(b).values(a).returning();return G.invalidate(`events:user:${a.ownerId}`),G.set(`event:${o.id}`,o),o})}async updateEvent(a,o){return D(async()=>{console.log("Atualizando evento com dados:",JSON.stringify(o,null,2)),console.log("Formato do evento recebido:",o.format),console.log("MeetingUrl recebido:",o.meetingUrl);let u={...o,updatedAt:new Date};console.log("Dados a serem salvos:",JSON.stringify(u,null,2));let[m]=await g.update(b).set(u).where(I(b.id,a)).returning();return console.log("Evento atualizado no banco:",JSON.stringify(m,null,2)),G.invalidate(`event:${a}`),G.invalidate("events:user:"),G.invalidate("events:"),m})}async deleteEvent(a){return D(async()=>{let[o]=await g.select().from(b).where(I(b.id,a));if(o){console.log(`[Storage] Deletando evento ${a} e todos os dados relacionados...`);let u=await g.select({feedbackId:U.feedbackId}).from(U).where(I(U.eventId,a));if(u.length>0)for(let y of u)await g.delete(Q).where(I(Q.feedbackId,y.feedbackId));await g.delete(U).where(I(U.eventId,a)),await g.delete(O).where(I(O.eventId,a)),await g.delete(B).where(I(B.eventId,a)),await g.delete(T).where(I(T.eventId,a)),await g.delete(L).where(I(L.eventId,a)),await g.delete(M).where(I(M.eventId,a)),await g.delete(V).where(I(V.eventId,a)),await g.delete(P).where(I(P.eventId,a)),await g.delete(q).where(I(q.eventId,a));let m=await g.select({id:x.id}).from(x).where(I(x.eventId,a));if(m.length>0)for(let y of m)await g.delete(R).where(I(R.taskId,y.id));await g.delete(x).where(I(x.eventId,a)),await g.delete(b).where(I(b.id,a)),G.invalidate(`event:${a}`),G.invalidate(`events:user:${o.ownerId}`),G.invalidate("events:user:"),C.invalidate(`tasks:event:${a}`),z.invalidate(`documents:event:${a}`),Y.invalidate(`participants:event:${a}`),console.log(`[Storage] Evento ${a} deletado com sucesso.`)}})}async getTasksByEventId(a){let o=`tasks:event:${a}`,u=C.get(o);return u||D(async()=>{let m=await g.select().from(x).where(I(x.eventId,a)).orderBy(x.dueDate);return C.set(o,m),m})}async getTaskById(a){let o=`task:${a}`,u=C.get(o);return u||D(async()=>{let[m]=await g.select().from(x).where(I(x.id,a));return m&&C.set(o,m),m})}async createTask(a,o){return D(async()=>{let[u]=await g.insert(x).values(a).returning();return o&&o.length>0&&await this.replaceTaskAssignees(u.id,o),C.invalidate(`tasks:event:${a.eventId}`),C.set(`task:${u.id}`,u),u})}async updateTask(a,o,u){return D(async()=>{let[m]=await g.update(x).set({...o,updatedAt:new Date}).where(I(x.id,a)).returning();if(u!==void 0&&await this.replaceTaskAssignees(m.id,u),C.set(`task:${a}`,m),o.eventId){let y=await this.getTaskById(a);y&&y.eventId!==o.eventId&&C.invalidate(`tasks:event:${y.eventId}`),C.invalidate(`tasks:event:${o.eventId}`)}else C.invalidate(`tasks:event:${m.eventId}`);return m})}async deleteTask(a){return D(async()=>{let o=await this.getTaskById(a);await g.delete(x).where(I(x.id,a)),C.invalidate(`task:${a}`),o&&C.invalidate(`tasks:event:${o.eventId}`)})}async getTeamMembersByEventId(a){let o=await g.select().from(P).where(I(P.eventId,a));return Promise.all(o.map(async u=>{let[m]=await g.select().from(j).where(I(j.id,u.userId)),y=u.permissions;if(typeof y=="string")try{y=JSON.parse(y)}catch{y={}}return{...u,permissions:y,user:m}}))}async addTeamMember(a){if((await g.select().from(P).where(X(I(P.eventId,a.eventId),I(P.userId,a.userId)))).length>0){let[m]=await g.update(P).set({role:a.role,permissions:a.permissions}).where(X(I(P.eventId,a.eventId),I(P.userId,a.userId))).returning();return m}let[u]=await g.insert(P).values(a).returning();return u}async removeTeamMember(a,o){return D(async()=>{let u=await g.delete(P).where(X(I(P.eventId,a),I(P.userId,o)));console.log(`Removendo membro da equipe - EventId: ${a}, UserId: ${o}, Linhas afetadas:`,u),J.invalidate(`team:event:${a}`)})}async isUserTeamMember(a,o){console.log(`Verificando se usu\xE1rio ${a} \xE9 membro da equipe do evento ${o}`);try{let u=await g.select().from(P).where(X(I(P.eventId,o),I(P.userId,a)));return console.log(`Encontrados ${u.length} registros para o usu\xE1rio na equipe`),console.log("Registros:",JSON.stringify(u)),u.length>0}catch(u){return console.error(`Erro ao verificar se usu\xE1rio ${a} \xE9 membro da equipe:`,u),!1}}async hasUserAccessToEvent(a,o){return D(async()=>{if(console.log(`Verificando acesso do usu\xE1rio ${a} ao evento ${o}`),!a||a==="undefined")return console.log("UserId \xE9 undefined ou inv\xE1lido"),!1;let[u]=await g.select().from(b).where(X(I(b.id,o),I(b.ownerId,a)));if(console.log("Evento encontrado como propriet\xE1rio:",u?"SIM":"N\xC3O"),u)return!0;let m=await this.isUserTeamMember(a,o);return console.log("Usu\xE1rio \xE9 membro da equipe:",m?"SIM":"N\xC3O"),m})}async getVendorsByEventId(a){console.log(`Buscando fornecedores para o evento ${a}`);try{let o=await g.select().from(V).where(I(V.eventId,a));return console.log(`Encontrados ${o.length} fornecedores para o evento ${a}`),console.log("Exemplo de fornecedor encontrado:",o.length>0?o[0]:"Nenhum"),o}catch(o){return console.error(`Erro ao buscar fornecedores para o evento ${a}:`,o),[]}}async getVendorById(a){let[o]=await g.select().from(V).where(I(V.id,a));return o}async createVendor(a){let[o]=await g.insert(V).values(a).returning();return o}async updateVendor(a,o){let[u]=await g.update(V).set({...o,updatedAt:new Date}).where(I(V.id,a)).returning();return u}async deleteVendor(a){await g.delete(V).where(I(V.id,a))}async getActivityLogsByEventId(a){return(await g.select().from(q).where(I(q.eventId,a)).orderBy(te(q.createdAt))).map(u=>{let m=u.details;if(typeof m=="string")try{m=JSON.parse(m)}catch{m={}}return{...u,details:m}})}async createActivityLog(a){let[o]=await g.insert(q).values(a).returning();return o}async getBudgetItemsByEventId(a){return g.select().from(M).where(I(M.eventId,a)).orderBy(te(M.createdAt))}async getBudgetItemById(a){let[o]=await g.select().from(M).where(I(M.id,a)).limit(1);return o}async createBudgetItem(a){let[o]=await g.insert(M).values(a).returning();return o}async updateBudgetItem(a,o){let[u]=await g.update(M).set({...o,updatedAt:new Date}).where(I(M.id,a)).returning();return u}async deleteBudgetItem(a){await g.delete(M).where(I(M.id,a))}async getExpensesByEventId(a){return g.select().from(L).where(I(L.eventId,a)).orderBy(te(L.createdAt))}async getExpenseById(a){let[o]=await g.select().from(L).where(I(L.id,a)).limit(1);return o}async createExpense(a){let[o]=await g.insert(L).values(a).returning();if(await this.getEventById(a.eventId)){let m=await this.calculateEventTotalExpenses(a.eventId);await this.updateEvent(a.eventId,{expenses:m})}return o}async updateExpense(a,o){let[u]=await g.update(L).set({...o,updatedAt:new Date}).where(I(L.id,a)).returning();if(o.amount!==void 0||o.eventId!==void 0){let m=o.eventId!==void 0?o.eventId:u.eventId,y=await this.calculateEventTotalExpenses(m);await this.updateEvent(m,{expenses:y})}return u}async deleteExpense(a){let o=await this.getExpenseById(a);if(o){await g.delete(L).where(I(L.id,a));let u=await this.calculateEventTotalExpenses(o.eventId);await this.updateEvent(o.eventId,{expenses:u})}}async calculateEventTotalExpenses(a){let o=await g.select({total:ge`SUM(${L.amount})`}).from(L).where(I(L.eventId,a));return Number(o[0]?.total||0)}async getTaskAssignees(a){return D(async()=>{let o=await g.select().from(R).where(I(R.taskId,a));return Promise.all(o.map(async u=>{let[m]=await g.select().from(j).where(I(j.id,u.userId));return{...u,user:m}}))})}async addTaskAssignee(a,o){return D(async()=>{let u=await g.select().from(R).where(X(I(R.taskId,a),I(R.userId,o)));if(u.length>0)return u[0];let[m]=await g.insert(R).values({taskId:a,userId:o}).returning(),[y]=await g.select().from(x).where(I(x.id,a));return y&&y.eventId&&C.invalidate(`tasks:event:${y.eventId}`),m})}async removeTaskAssignee(a,o){return D(async()=>{let[u]=await g.select().from(x).where(I(x.id,a));await g.delete(R).where(X(I(R.taskId,a),I(R.userId,o))),u&&u.eventId&&C.invalidate(`tasks:event:${u.eventId}`)})}async replaceTaskAssignees(a,o){return D(async()=>{let[u]=await g.select().from(x).where(I(x.id,a));if(await g.delete(R).where(I(R.taskId,a)),!o||o.length===0)return[];let m=await Promise.all(o.map(async y=>{let[s]=await g.insert(R).values({taskId:a,userId:y}).returning();return s}));return u&&u.eventId&&C.invalidate(`tasks:event:${u.eventId}`),m})}async getDocumentsByEventId(a){let o=`documents:event:${a}`,u=z.get(o);return u||D(async()=>{let m=await g.select().from(B).where(I(B.eventId,a)).orderBy(te(B.uploadedAt));return z.set(o,m),m})}async getDocumentById(a){let o=`document:${a}`,u=z.get(o);return u||D(async()=>{let[m]=await g.select().from(B).where(I(B.id,a));return m&&z.set(o,m),m})}async getDocumentsByCategory(a,o){let u=`documents:event:${a}:category:${o}`,m=z.get(u);return m||D(async()=>{let y=await g.select().from(B).where(X(I(B.eventId,a),I(B.category,o))).orderBy(te(B.uploadedAt));return z.set(u,y),y})}async createDocument(a){return D(async()=>{let[o]=await g.insert(B).values(a).returning();return z.invalidate(`documents:event:${a.eventId}`),z.invalidate(`documents:event:${a.eventId}:category:${a.category}`),z.set(`document:${o.id}`,o),o})}async updateDocument(a,o){return D(async()=>{let[u]=await g.update(B).set({...o,updatedAt:new Date}).where(I(B.id,a)).returning();return z.invalidate(`documents:event:${u.eventId}`),z.invalidate(`documents:event:${u.eventId}:category:${u.category}`),z.set(`document:${u.id}`,u),u})}async deleteDocument(a){return D(async()=>{let o=await this.getDocumentById(a);o&&(await g.delete(B).where(I(B.id,a)),z.invalidate(`documents:event:${o.eventId}`),z.invalidate(`documents:event:${o.eventId}:category:${o.category}`),z.invalidate(`document:${a}`))})}async getParticipantsByEventId(a){let o=`participants:event:${a}`,u=Y.get(o);return u||D(async()=>{let m=await g.select().from(O).where(I(O.eventId,a)).orderBy(O.name);return Y.set(o,m),m})}async getParticipantById(a){let o=`participant:${a}`,u=Y.get(o);return u||D(async()=>{let[m]=await g.select().from(O).where(I(O.id,a));return m&&Y.set(o,m),m})}async createParticipant(a){return D(async()=>{let[o]=await g.insert(O).values(a).returning();return Y.invalidate(`participants:event:${a.eventId}`),Y.set(`participant:${o.id}`,o),o})}async createParticipants(a){return D(async()=>{let o=await g.insert(O).values(a).returning();return Array.from(new Set(a.map(m=>m.eventId))).forEach(m=>{Y.invalidate(`participants:event:${m}`)}),o.forEach(m=>{Y.set(`participant:${m.id}`,m)}),o})}async updateParticipant(a,o){return D(async()=>{let[u]=await g.update(O).set({...o,updatedAt:new Date}).where(I(O.id,a)).returning();return Y.invalidate(`participants:event:${u.eventId}`),Y.set(`participant:${u.id}`,u),u})}async deleteParticipant(a){return D(async()=>{let o=await this.getParticipantById(a);o&&(await g.delete(O).where(I(O.id,a)),Y.invalidate(`participants:event:${o.eventId}`),Y.invalidate(`participant:${a}`))})}async getParticipantStats(a){return D(async()=>{let o=await this.getParticipantsByEventId(a),u=o.length,m=o.filter(s=>s.status==="confirmed").length,y=o.filter(s=>s.status==="pending").length;return{total:u,confirmed:m,pending:y}})}async getFeedbacksByEventId(a){return D(async()=>await g.select().from(U).where(I(U.eventId,a)).orderBy(te(U.createdAt)))}async getFeedbackByFeedbackId(a){return D(async()=>{let[o]=await g.select({id:U.id,eventId:U.eventId,feedbackId:U.feedbackId,name:U.name,email:U.email,rating:U.rating,comment:U.comment,isAnonymous:U.isAnonymous,createdAt:U.createdAt,event:b}).from(U).innerJoin(b,I(U.eventId,b.id)).where(I(U.feedbackId,a));return o})}async createFeedback(a){return D(async()=>{let[o]=await g.insert(U).values(a).returning();return o})}async deleteFeedback(a){return D(async()=>{await g.delete(U).where(I(U.id,a))})}async generateFeedbackLink(a){return D(async()=>{let o=`feedback_${a}_${Date.now()}_${Math.random().toString(36).substring(2,15)}`,u=await g.select().from(U).where(X(I(U.eventId,a),mt(U.feedbackId))).limit(1);return u.length>0?u[0].feedbackId:o})}async getFeedbackStats(a){return D(async()=>{let o=await g.select().from(U).where(X(I(U.eventId,a),ge`${U.rating} > 0`)),u=o.length;if(u===0)return{total:0,averageRating:0,anonymousPercentage:0};let y=o.reduce((e,n)=>e+n.rating,0)/u,t=o.filter(e=>e.isAnonymous).length/u*100;return{total:u,averageRating:Math.round(y*10)/10,anonymousPercentage:Math.round(t)}})}async createFeedbackMetric(a){return D(async()=>{let[o]=await g.insert(Q).values(a).returning();return o})}async updateFeedbackMetricSubmission(a,o,u){return D(async()=>{await g.update(Q).set({submittedAt:new Date,ipAddress:o,userAgent:u}).where(I(Q.feedbackId,a))})}async getEventByFeedbackId(a){return D(async()=>{let[o]=await g.select({event:b}).from(U).innerJoin(b,I(U.eventId,b.id)).where(I(U.feedbackId,a));return o?.event})}async getEventFeedbackByFeedbackId(a){return D(async()=>{let[o]=await g.select({eventId:U.eventId,feedbackId:U.feedbackId}).from(U).where(I(U.feedbackId,a));return o})}async getEventFeedbacks(a){return D(async()=>{let o=await g.select().from(U).where(X(I(U.eventId,a),ge`${U.rating} > 0`)).orderBy(te(U.createdAt));return console.log(`[DEBUG] Encontrados ${o.length} feedbacks v\xE1lidos para evento ${a}`),o})}async getExistingFeedbackLink(a){return D(async()=>{let[o]=await g.select({feedbackUrl:b.feedbackUrl}).from(b).where(I(b.id,a));return o?.feedbackUrl||null})}async getDraftEventByUser(a){return D(async()=>{let[o]=await g.select().from(b).where(X(I(b.ownerId,a),I(b.status,"draft"))).orderBy(te(b.updatedAt)).limit(1);return o})}async saveDraftEvent(a,o){return D(async()=>{let u=await this.getDraftEventByUser(a);if(u){let[m]=await g.update(b).set({...o,status:"draft",updatedAt:new Date}).where(I(b.id,u.id)).returning();return G.invalidate(`event:${u.id}`),m}else{let[m]=await g.insert(b).values({name:o.name||"Rascunho",type:o.type||"other",format:o.format||"in_person",startDate:o.startDate||new Date,endDate:o.endDate,startTime:o.startTime,endTime:o.endTime,location:o.location,meetingUrl:o.meetingUrl,description:o.description,budget:o.budget,attendees:o.attendees,coverImageUrl:o.coverImageUrl,status:"draft",ownerId:a,createdAt:new Date,updatedAt:new Date}).returning();return m}})}async deleteDraftEvent(a){return D(async()=>{let o=await this.getDraftEventByUser(a);o&&(await g.delete(b).where(I(b.id,o.id)),G.invalidate(`event:${o.id}`))})}},c=new Ue;import ve from"fs";import Ne from"path";function je(d,a){try{let o=d.match(/^data:image\/([a-zA-Z]*);base64,(.+)$/);if(!o)throw new Error("Invalid base64 image format");let u=o[1],m=Buffer.from(o[2],"base64"),y=Ne.join(process.cwd(),"public","uploads","events");ve.existsSync(y)||ve.mkdirSync(y,{recursive:!0});let s=`event-${a}-${Date.now()}.${u}`,t=Ne.join(y,s);return ve.writeFileSync(t,m),`/uploads/events/${s}`}catch(o){throw console.error("Erro ao salvar imagem:",o),new Error("Falha ao processar upload da imagem")}}function Se(d){try{if(d.startsWith("/uploads/")){let a=Ne.join(process.cwd(),"public",d);ve.existsSync(a)&&ve.unlinkSync(a)}}catch(a){console.error("Erro ao deletar imagem:",a)}}oe();import{eq as ce}from"drizzle-orm";import{createClient as Kt}from"@supabase/supabase-js";import Pe from"express-session";import pt from"memorystore";var $e=new Map,Zt=5*60*1e3;async function ie(d,a){if(!d)return console.warn(`[Auth] getEffectiveUserId: No email provided, returning UUID ${a}`),a;try{console.log(`[Auth] getEffectiveUserId: Searching DB for email: ${d}`);let u=await(await c).getUserByEmail(d);if(u)return $e.set(d,{userId:u.id,timestamp:Date.now()}),console.log(`[Auth] getEffectiveUserId (DB MATCH): ${d} -> ${u.id} (Supabase UUID was: ${a})`),u.id;console.log(`[Auth] getEffectiveUserId: No user found in DB for ${d}. Will use UUID.`)}catch(o){return console.error(`[Auth] getEffectiveUserId DB lookup FAILED for ${d}. Error: ${o.message}`),a}return console.log(`[Auth] getEffectiveUserId (NEW USER): ${d} -> caching UUID ${a}`),$e.set(d,{userId:a,timestamp:Date.now()}),a}function gt(){let a=pt(Pe),o=new a({checkPeriod:864e5});return Pe({secret:process.env.SESSION_SECRET||"supabase-session-secret-dev",store:o,resave:!1,saveUninitialized:!1,rolling:!0,cookie:{httpOnly:!1,secure:!1,sameSite:"lax",maxAge:2592e6}})}async function Be(d){d.set("trust proxy",1),d.use(gt()),d.get("/api/supabase-config",(a,o)=>{o.json({url:process.env.SUPABASE_URL,anonKey:process.env.SUPABASE_ANON_KEY})}),d.get("/api/logout",(a,o)=>{a.session.destroy(u=>{u&&console.error("Erro ao destruir sess\xE3o:",u),o.redirect("/auth")})})}var E=async(d,a,o)=>{let u=d.headers.authorization;if(!u||!u.startsWith("Bearer "))return console.log("[Auth] Token n\xE3o fornecido no header Authorization"),a.status(401).json({message:"Unauthorized - No token provided"});let m=u.substring(7);try{let y=m.split(".");if(y.length!==3)return console.log("[Auth] Token JWT inv\xE1lido - formato incorreto"),a.status(401).json({message:"Unauthorized - Invalid token format"});let s=JSON.parse(Buffer.from(y[1],"base64").toString()),t=Math.floor(Date.now()/1e3);if(s.exp&&s.exp<t)return console.log("[Auth] Token expirado"),a.status(401).json({message:"Unauthorized - Token expired"});let e=s.sub,n=s.email,r=s.user_metadata||{};if(!e)return console.log("[Auth] Token n\xE3o cont\xE9m user ID"),a.status(401).json({message:"Unauthorized - No user ID in token"});if(!n)return console.log("[Auth] Token n\xE3o cont\xE9m email"),a.status(401).json({message:"Unauthorized - No email in token"});let i=await ie(n,e);return console.log("[Auth] Resolu\xE7\xE3o de ID - Supabase UUID:",e,"-> ID efetivo:",i,"Email:",n),d.user={claims:{sub:i,supabaseId:e,email:n,name:r.full_name||r.name||n?.split("@")[0],picture:r.avatar_url||r.picture}},o()}catch(y){return console.error("[Auth] Erro ao verificar token:",y.message),a.status(401).json({message:"Unauthorized - Token verification failed"})}};oe();import Et from"csv-parser";import*as we from"xlsx";import{z as S}from"zod";import vt from"openai";var qt=process.env.OPENAI_API_KEY?new vt({apiKey:process.env.OPENAI_API_KEY}):null;async function Te(d){try{let a=new Date(d.startDate),o=new Date,u=Math.ceil((a.getTime()-o.getTime())/(1e3*60*60*24));console.log("Gerando checklist universal para evento:",d.name),console.log("Tipo de evento:",d.type),console.log("Dias at\xE9 o evento:",u);let m=[],y=(d.attendees||0)>=100,s=(d.budget||0)>=2e4,t=!!d.location,e=d.name?.toLowerCase().includes("workshop")||d.description?.toLowerCase().includes("workshop")||d.description?.toLowerCase().includes("intensivo")||d.description?.toLowerCase().includes("aprenda")||d.description?.toLowerCase().includes("curso")||d.description?.toLowerCase().includes("treinamento"),n=d.name?.toLowerCase().includes("cole\xE7\xE3o")||d.name?.toLowerCase().includes("moda")||d.name?.toLowerCase().includes("desfile");m.push({title:"Definir objetivos e prop\xF3sito do evento",dueDateBefore:Math.min(u-3,45),description:"Estabelecer metas claras, p\xFAblico-alvo e resultados esperados",priority:"high"}),t?m.push({title:"Confirmar reserva e preparar espa\xE7o",dueDateBefore:Math.min(u-5,20),description:`Finalizar detalhes com ${d.location} e planejar layout`,priority:"high"}):m.push({title:"Pesquisar e reservar local",dueDateBefore:Math.min(u-10,30),description:`Encontrar espa\xE7o adequado para ${d.attendees||"todos"} participantes`,priority:"high"}),e&&(m.push({title:"Preparar conte\xFAdo e material did\xE1tico",dueDateBefore:Math.min(u-5,25),description:"Desenvolver apostilas, apresenta\xE7\xF5es e exerc\xEDcios pr\xE1ticos",priority:"high"}),m.push({title:"Testar equipamentos e materiais",dueDateBefore:Math.min(u-2,7),description:"Verificar som, proje\xE7\xE3o e materiais necess\xE1rios",priority:"high"})),n&&(m.push({title:"Definir conceito e tema",dueDateBefore:Math.min(u-10,30),description:"Finalizar conceito, paleta de cores e tema geral",priority:"high"}),m.push({title:"Contratar modelos e equipe de produ\xE7\xE3o",dueDateBefore:Math.min(u-8,25),description:"Selecionar modelos, fot\xF3grafos e equipe t\xE9cnica",priority:"high"})),m.push({title:"Criar lista de participantes",dueDateBefore:Math.min(u-7,25),description:`Desenvolver lista completa para ${d.attendees||""} pessoas`,priority:"high"}),m.push({title:"Criar e enviar convites",dueDateBefore:Math.min(u-5,20),description:"Desenvolver convites e sistema de confirma\xE7\xE3o",priority:"high"}),m.push({title:"Criar estrat\xE9gia de divulga\xE7\xE3o",dueDateBefore:Math.min(u-10,15),description:"Planejar marketing digital e redes sociais",priority:"medium"}),d.budget&&d.budget>1e3&&m.push({title:"Organizar alimenta\xE7\xE3o e bebidas",dueDateBefore:Math.min(u-5,15),description:"Contratar catering ou organizar coffee break",priority:"medium"}),m.push({title:"Contratar servi\xE7os audiovisuais",dueDateBefore:Math.min(u-8,20),description:"Garantir som, ilumina\xE7\xE3o e equipamentos necess\xE1rios",priority:s||y?"high":"medium"}),y&&(m.push({title:"Organizar equipe de apoio",dueDateBefore:Math.min(u-5,15),description:"Definir recep\xE7\xE3o, controle de acesso e suporte",priority:"medium"}),m.push({title:"Sistema de credenciamento",dueDateBefore:Math.min(u-3,10),description:"Configurar processo de entrada e identifica\xE7\xE3o",priority:"medium"})),m.push({title:"Confirmar presen\xE7a dos participantes",dueDateBefore:Math.min(u-2,5),description:"Fazer follow-up final e organizar lista de confirmados",priority:"medium"}),m.push({title:"Preparar materiais do evento",dueDateBefore:1,description:"Organizar crach\xE1s, kits e materiais de distribui\xE7\xE3o",priority:"high"}),m.push({title:"Revisar log\xEDstica final",dueDateBefore:1,description:"Verificar todos os detalhes e preparativos finais",priority:"high"}),m.push({title:"Coletar feedback dos participantes",dueDateBefore:-2,description:"Enviar formul\xE1rio de avalia\xE7\xE3o e coletar sugest\xF5es",priority:"medium"});let r=m.map(i=>{let l;return i.dueDateBefore>0?(l=new Date(a),l.setDate(l.getDate()-i.dueDateBefore)):i.dueDateBefore<0?(l=new Date(a),l.setDate(l.getDate()+Math.abs(i.dueDateBefore))):l=new Date(a),{title:i.title,description:i.description,dueDate:l,priority:i.priority}});return console.log(`Checklist gerado com ${r.length} tarefas`),r}catch(a){return console.error("Erro ao gerar checklist:",a),[]}}import{Router as ft}from"express";import{z as _e}from"zod";oe();import{eq as ue}from"drizzle-orm";var le=ft();le.get("/events/:eventId/schedule",E,async(d,a)=>{try{let o=d.user.claims.sub,u=parseInt(d.params.eventId);if(isNaN(u))return a.status(400).json({message:"ID de evento inv\xE1lido"});if(!await c.hasUserAccessToEvent(o,u))return a.status(403).json({message:"Voc\xEA n\xE3o tem acesso a este evento"});let y=await g.select().from(T).where(ue(T.eventId,u)).orderBy(T.startTime);a.json(y)}catch(o){console.error("Erro ao buscar itens do cronograma:",o),a.status(500).json({message:"Erro ao buscar itens do cronograma"})}});le.get("/schedule/:id",E,async(d,a)=>{try{let o=d.user.claims.sub,u=parseInt(d.params.id);if(isNaN(u))return a.status(400).json({message:"ID de item inv\xE1lido"});let m=await g.select().from(T).where(ue(T.id,u));if(m.length===0)return a.status(404).json({message:"Item do cronograma n\xE3o encontrado"});if(!await c.hasUserAccessToEvent(o,m[0].eventId))return a.status(403).json({message:"Voc\xEA n\xE3o tem acesso a este item"});a.json(m[0])}catch(o){console.error("Erro ao buscar item do cronograma:",o),a.status(500).json({message:"Erro ao buscar item do cronograma"})}});le.post("/events/:eventId/schedule",E,async(d,a)=>{try{let o=d.user.claims.sub,u=parseInt(d.params.eventId);if(isNaN(u))return a.status(400).json({message:"ID de evento inv\xE1lido"});if(!await c.hasUserAccessToEvent(o,u))return a.status(403).json({message:"Voc\xEA n\xE3o tem acesso a este evento"});let y=he.parse({...d.body,eventId:u}),s=await g.insert(T).values(y).returning();a.status(201).json(s[0])}catch(o){if(console.error("Erro ao criar item do cronograma:",o),o instanceof _e.ZodError)return a.status(400).json({message:"Dados inv\xE1lidos para o item do cronograma",errors:o.errors});a.status(500).json({message:"Erro ao criar item do cronograma"})}});le.put("/schedule/:id",E,async(d,a)=>{try{let o=d.user.claims.sub,u=parseInt(d.params.id);if(isNaN(u))return a.status(400).json({message:"ID de item inv\xE1lido"});let m=await g.select().from(T).where(ue(T.id,u));if(m.length===0)return a.status(404).json({message:"Item do cronograma n\xE3o encontrado"});if(!await c.hasUserAccessToEvent(o,m[0].eventId))return a.status(403).json({message:"Voc\xEA n\xE3o tem acesso a este item"});let s=he.partial().parse(d.body),t=await g.update(T).set({...s,updatedAt:new Date}).where(ue(T.id,u)).returning();a.json(t[0])}catch(o){if(console.error("Erro ao atualizar item do cronograma:",o),o instanceof _e.ZodError)return a.status(400).json({message:"Dados inv\xE1lidos para o item do cronograma",errors:o.errors});a.status(500).json({message:"Erro ao atualizar item do cronograma"})}});le.delete("/schedule/:id",E,async(d,a)=>{try{let o=d.user.claims.sub,u=parseInt(d.params.id);if(isNaN(u))return a.status(400).json({message:"ID de item inv\xE1lido"});let m=await g.select().from(T).where(ue(T.id,u));if(m.length===0)return a.status(404).json({message:"Item do cronograma n\xE3o encontrado"});if(!await c.hasUserAccessToEvent(o,m[0].eventId))return a.status(403).json({message:"Voc\xEA n\xE3o tem acesso a este item"});await g.delete(T).where(ue(T.id,u)),a.json({success:!0,message:"Item do cronograma exclu\xEDdo com sucesso"})}catch(o){console.error("Erro ao excluir item do cronograma:",o),a.status(500).json({message:"Erro ao excluir item do cronograma"})}});var Fe=le;import{Router as It}from"express";var yt=(d,a,o)=>{console.log(`[DEBUG CRONOGRAMA] Acessando rota: ${d.method} ${d.originalUrl}`),console.log(`[DEBUG CRONOGRAMA] Usu\xE1rio autenticado: ${d.user?d.user.claims.sub:"N\xE3o autenticado"}`),o()},fe=It();fe.get("/events/:eventId/schedule",yt,E,async(d,a)=>{try{let o=d.user.claims.sub,u=parseInt(d.params.eventId,10);if(isNaN(u))return a.status(400).json({message:"ID de evento inv\xE1lido"});if(!await c.hasUserAccessToEvent(o,u))return a.status(403).json({message:"Voc\xEA n\xE3o tem acesso a este evento"});let s=(await g.execute(`
      SELECT id, event_id, title, description, start_time, location, responsibles, 
             created_at, updated_at
      FROM schedule_items 
      WHERE event_id = ${u} 
      ORDER BY start_time
    `)).rows.map(t=>({id:t.id,eventId:t.event_id,title:t.title,description:t.description,startTime:t.start_time,location:t.location,responsibles:t.responsibles,createdAt:t.created_at,updatedAt:t.updated_at}));a.json(s)}catch(o){console.error("Erro ao buscar itens do cronograma:",o),a.status(500).json({message:"Falha ao buscar itens do cronograma"})}});fe.post("/events/:eventId/schedule",E,async(d,a)=>{try{let o=d.user.claims.sub,u=parseInt(d.params.eventId,10);if(isNaN(u))return a.status(400).json({message:"ID de evento inv\xE1lido"});if(!await c.hasUserAccessToEvent(o,u))return a.status(403).json({message:"Voc\xEA n\xE3o tem acesso a este evento"});let{title:y,description:s,startTime:t,location:e,responsibles:n}=d.body;if(!y||!t)return a.status(400).json({message:"T\xEDtulo e hor\xE1rio de in\xEDcio s\xE3o obrigat\xF3rios"});let r=s||null,i=e||null,l=n||null,v=(await g.execute(`
      INSERT INTO schedule_items 
        (event_id, title, description, start_time, location, responsibles, created_at, updated_at) 
      VALUES 
        (${u}, '${String(y).replace(/'/g,"''")}', ${r?`'${String(r).replace(/'/g,"''")}'`:"NULL"}, '${String(t).replace(/'/g,"''")}', ${i?`'${String(i).replace(/'/g,"''")}'`:"NULL"}, ${l?`'${String(l).replace(/'/g,"''")}'`:"NULL"}, NOW(), NOW())
      RETURNING id, event_id, title, description, start_time, location, responsibles, 
                created_at, updated_at
    `)).rows[0],h={id:v.id,eventId:v.event_id,title:v.title,description:v.description,startTime:v.start_time,location:v.location,responsibles:v.responsibles,createdAt:v.created_at,updatedAt:v.updated_at};a.status(201).json(h)}catch(o){console.error("Erro ao adicionar item ao cronograma:",o),a.status(500).json({message:"Falha ao adicionar item ao cronograma"})}});fe.put("/schedule/:id",E,async(d,a)=>{try{let o=d.user.claims.sub,u=parseInt(d.params.id,10);if(isNaN(u))return a.status(400).json({message:"ID de item inv\xE1lido"});let m=await g.execute(`
      SELECT event_id FROM schedule_items WHERE id = ${u}
    `);if(m.rows.length===0)return a.status(404).json({message:"Item n\xE3o encontrado"});let y=m.rows[0].event_id;if(!await c.hasUserAccessToEvent(o,y))return a.status(403).json({message:"Voc\xEA n\xE3o tem acesso a este item"});let{title:t,description:e,startTime:n,location:r,responsibles:i}=d.body;if(!t||!n)return a.status(400).json({message:"T\xEDtulo e hor\xE1rio de in\xEDcio s\xE3o obrigat\xF3rios"});let l=e||null,p=r||null,v=i||null,h=await g.execute(`
      UPDATE schedule_items 
      SET 
        title = '${String(t).replace(/'/g,"''")}', 
        description = ${l?`'${String(l).replace(/'/g,"''")}'`:"NULL"}, 
        start_time = '${String(n).replace(/'/g,"''")}', 
        location = ${p?`'${String(p).replace(/'/g,"''")}'`:"NULL"}, 
        responsibles = ${v?`'${String(v).replace(/'/g,"''")}'`:"NULL"}, 
        updated_at = NOW()
      WHERE id = ${u}
      RETURNING id, event_id, title, description, start_time, location, responsibles, 
                created_at, updated_at
    `);if(h.rows.length===0)return a.status(404).json({message:"Falha ao atualizar o item"});let w=h.rows[0],f={id:w.id,eventId:w.event_id,title:w.title,description:w.description,startTime:w.start_time,location:w.location,responsibles:w.responsibles,createdAt:w.created_at,updatedAt:w.updated_at};a.json(f)}catch(o){console.error("Erro ao atualizar item do cronograma:",o),a.status(500).json({message:"Falha ao atualizar item do cronograma"})}});fe.delete("/schedule/:id",E,async(d,a)=>{try{let o=d.user.claims.sub,u=parseInt(d.params.id,10);if(isNaN(u))return a.status(400).json({message:"ID de item inv\xE1lido"});let m=await g.execute(`
      SELECT event_id FROM schedule_items WHERE id = ${u}
    `);if(m.rows.length===0)return a.status(404).json({message:"Item n\xE3o encontrado"});let y=m.rows[0].event_id;if(!await c.hasUserAccessToEvent(o,y))return a.status(403).json({message:"Voc\xEA n\xE3o tem acesso a este item"});await g.execute(`
      DELETE FROM schedule_items WHERE id = ${u}
    `),a.json({success:!0,message:"Item exclu\xEDdo com sucesso"})}catch(o){console.error("Erro ao excluir item do cronograma:",o),a.status(500).json({message:"Falha ao excluir item do cronograma"})}});var Oe=fe;function Le(d){d.get("/api/events/:eventId/cronograma",async(a,o)=>{try{console.log("Iniciando requisi\xE7\xE3o para o cronograma direto");let u=parseInt(a.params.eventId,10);if(isNaN(u))return o.status(400).json({message:"ID de evento inv\xE1lido"});console.log("Executando consulta para o evento ID:",u);let m=`
        SELECT id, event_id, title, description, start_time, location, responsibles, 
               created_at, updated_at
        FROM schedule_items 
        WHERE event_id = ${u} 
        ORDER BY start_time
      `;console.log("Query:",m);let y=await g.execute(m);console.log(`Itens encontrados no cronograma: ${y.rows.length}`);let s=y.rows.map(t=>({id:t.id,eventId:t.event_id,title:t.title,description:t.description,startTime:t.start_time,location:t.location,responsibles:t.responsibles,createdAt:t.created_at,updatedAt:t.updated_at}));o.json(s)}catch(u){console.error("Erro ao buscar cronograma (rota direta):",u),o.status(500).json({message:"Falha ao buscar itens do cronograma"})}})}var ae=d=>{console.log(`[DEBUG] ${d}`);try{process.env.NODE_ENV!=="production"&&Z.appendFileSync(ne.join(process.cwd(),"debug.log"),`[${new Date().toISOString()}] ${d}
`)}catch{}},Re=d=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(d),Me=d=>{let a=d.replace(/\D/g,"");return a.length>=10&&a.length<=15},Ie=ne.join(process.cwd(),"public","uploads");try{Z.existsSync(Ie)||Z.mkdirSync(Ie,{recursive:!0})}catch{console.log("Skipping upload directory creation (serverless environment)")}var wt=Ee.diskStorage({destination:(d,a,o)=>{o(null,Ie)},filename:(d,a,o)=>{let u=Date.now(),m=a.originalname,y=ne.extname(m),s=ne.basename(m,y);o(null,`doc-${u}-${s.replace(/[^a-zA-Z0-9]/g,"_")}${y}`)}}),At=Ee({storage:wt,limits:{fileSize:50*1024*1024},fileFilter:(d,a,o)=>{let u=/jpeg|jpg|png|gif|pdf|doc|docx|xls|xlsx|ppt|pptx|txt|mp4|mov|avi|mp3|wav/,m=u.test(ne.extname(a.originalname).toLowerCase());if(u.test(a.mimetype)&&m)return o(null,!0);o(new Error("Tipo de arquivo n\xE3o permitido"))}});async function Ce(d){d.use("/uploads",bt.static(Ie)),await Be(d),d.get("/api/diag",async(s,t)=>{let e=[],n=r=>e.push(`[${new Date().toISOString()}] ${r}`);try{n(`Environment check: NODE_ENV=${process.env.NODE_ENV}`),n(`DB URL configured: ${!!process.env.DATABASE_URL}`);let r=await g.select({count:j.id}).from(j).limit(1);n("DB Connection OK. Users table accessible.");let i=s.query.email,l=s.query.supabaseId,p={status:"online",timestamp:new Date().toISOString(),buildVersion:"v2-diag-fix",env:process.env.NODE_ENV,logs:e};if(i&&l){n(`Testing resolution for email=${i}, supabaseId=${l}`);let v=await ie(i,l);n(`Resolved effectiveId: ${v}`),p.effectiveId=v;let h=await c.getUser(v);n(`User found in DB: ${!!h} (id=${h?.id})`),p.user=h?{id:h.id,email:h.email}:null;let w=await c.getEventsByUser(v);n(`Events found count: ${w.length}`),p.eventsCount=w.length,p.eventIds=w.map(f=>f.id).slice(0,5)}t.json(p)}catch(r){console.error("DIAG ERROR:",r),n(`ERROR: ${r.message}`),t.status(500).json({status:"error",message:r.message,logs:e})}}),d.get("/api/health",(s,t)=>{t.json({status:"ok",timestamp:new Date().toISOString(),env:process.env.NODE_ENV})}),d.get("/api/debug/user-events",E,async(s,t)=>{try{let e=s.user.claims.sub,n=s.user.claims.email,r=await c.getUserByEmail(n),i=await c.getUser(e),l=await ie(n,e),p=await c.getEventsByUser(l),v=await c.getEventsByUser(e),h=[];r&&r.id!==l&&r.id!==e&&(h=await c.getEventsByUser(r.id));let w=await g.select({id:b.id,ownerId:b.ownerId,name:b.name}).from(b);t.json({claims:{sub:e,email:n},userByEmail:r?{id:r.id,email:r.email}:null,userBySub:i?{id:i.id,email:i.email}:null,effectiveUserId:l,eventCounts:{byEffectiveId:p.length,bySupabaseUUID:v.length,byEmailUserId:h.length},allEventsInDB:w.map(f=>({id:f.id,ownerId:f.ownerId,name:f.name}))})}catch(e){t.status(500).json({error:e.message,stack:e.stack})}}),d.get("/api/auth/user",E,async(s,t)=>{try{let e=s.user.claims.sub,n=s.user.claims.email,r=s.user.claims.name,i=s.user.claims.picture;if(console.log("[Auth] Login via Supabase - UUID:",e,"Email:",n),ae(`AUTH_USER: sub=${e}, email=${n}`),!n)return console.error("[Auth] Email n\xE3o fornecido pelo Supabase!"),t.status(400).json({message:"Email is required"});let l=await c.getUserByEmail(n);if(l)return console.log("[Auth] Usu\xE1rio existente encontrado! Usando ID original:",l.id),ae(`AUTH_USER: existing user found id=${l.id}, returning this`),i&&l.profileImageUrl!==i&&(await c.upsertUser({...l,profileImageUrl:i}),l.profileImageUrl=i),t.json(l);let p=await c.getUser(e);if(p)return console.log("[Auth] Usu\xE1rio encontrado pelo ID:",p.id,"Email no banco:",p.email),i&&p.profileImageUrl!==i&&(await c.upsertUser({...p,profileImageUrl:i}),p.profileImageUrl=i),console.log("[Auth] LOGIN SUCCESS: Returning user by ID:",p.id),t.json(p);console.log("[Auth] Usu\xE1rio novo! Criando com UUID do Supabase:",e);let v={id:e,email:n,firstName:r?.split(" ")[0]||n.split("@")[0]||"Usu\xE1rio",lastName:r?.split(" ").slice(1).join(" ")||""};i&&(v.profileImageUrl=i);let h=await c.upsertUser(v);return console.log("[Auth] Novo usu\xE1rio criado:",h.id),t.json(h)}catch(e){console.error("[Auth] Erro detalhado:",e.message),console.error("[Auth] Stack:",e.stack),t.status(500).json({message:e.message||"Internal server error"})}}),d.get("/api/events",E,async(s,t)=>{try{let e=s.user.claims.email,n=await ie(e,s.user.claims.sub);console.log("========================================"),console.log("Buscando eventos para userId:",n,"email:",e),ae(`EVENTS: req.user.claims.sub=${s.user.claims.sub}, email=${e}, effectiveId=${n}`),console.log("Claims completos:",JSON.stringify(s.user.claims)),console.log("========================================");let r=await c.getEventsByUser(n);console.log("Eventos encontrados para userId",n,":",r.length),ae(`EVENTS: found ${r.length} events for userId=${n}`);for(let i of r){let l=await c.getVendorsByEventId(i.id);i.vendorCount=l.length}t.json(r)}catch(e){console.error("Error fetching events:",e),t.status(500).json({message:"Failed to fetch events"})}}),d.get("/api/events/:id",E,async(s,t)=>{try{let e=s.user.claims.email,n=s.user.claims.sub,r=n;e&&(r=await ie(e,n)),console.log("Usando ID resolvido:",r,"(Original:",n,")");let i=parseInt(s.params.id,10);if(isNaN(i))return console.log("ID de evento inv\xE1lido:",s.params.id),t.status(400).json({message:"Invalid event ID"});console.log(`Buscando evento ${i} para usu\xE1rio ${r}`);let l=await c.getEventById(i);if(!l)return console.log(`Evento ${i} n\xE3o encontrado`),t.status(404).json({message:"Event not found"});let p=l.ownerId===r;console.log(`O usu\xE1rio \xE9 o propriet\xE1rio do evento? ${p}`);let v=await c.isUserTeamMember(r,i);return console.log(`O usu\xE1rio \xE9 membro da equipe do evento? ${v}`),!p&&!v?(console.log(`Usu\xE1rio ${r} n\xE3o tem acesso ao evento ${i}`),t.status(403).json({message:"You don't have access to this event"})):(console.log(`Retornando evento com feedbackUrl: ${l.feedbackUrl||"null"}`),t.json(l))}catch(e){console.error("Error fetching event:",e),t.status(500).json({message:"Failed to fetch event"})}}),d.post("/api/events",E,async(s,t)=>{try{let e=s.user.claims.sub,n=ye.parse(s.body),r={name:n.name,type:n.type,format:n.format,description:n.description,location:n.location,meetingUrl:n.meetingUrl,budget:n.budget,attendees:n.attendees,coverImageUrl:"",startTime:n.startTime,endTime:n.endTime,startDate:new Date(n.startDate),ownerId:e};n.endDate&&(r.endDate=new Date(n.endDate));let i=await c.createEvent(r),l=n.coverImageUrl;if(l&&l.startsWith("data:image/"))try{l=je(l,i.id),console.log("[Debug API] Nova imagem salva para evento criado em:",l),await c.updateEvent(i.id,{coverImageUrl:l})}catch(p){console.error("[Debug API] Erro ao processar upload de imagem na cria\xE7\xE3o:",p)}if(await c.addTeamMember({eventId:i.id,userId:e,role:"organizer",permissions:JSON.stringify({canDelete:!0,canEdit:!0,canInvite:!0})}),console.log("[AI Checklist] generateAIChecklist value:",n.generateAIChecklist,"type:",typeof n.generateAIChecklist),n.generateAIChecklist){console.log("[AI Checklist] Iniciando gera\xE7\xE3o de tarefas para evento:",i.id);try{let p=await Te(n);console.log("[AI Checklist] Tarefas geradas:",p.length);for(let v of p)await c.createTask({title:v.title,description:v.description,dueDate:v.dueDate,priority:v.priority||"medium",eventId:i.id,assigneeId:e})}catch(p){console.error("Error generating AI checklist:",p)}}await c.createActivityLog({eventId:i.id,userId:e,action:"created_event",details:JSON.stringify({eventName:i.name})}),t.status(201).json(i)}catch(e){if(console.error("Error creating event:",e),e instanceof S.ZodError)return t.status(400).json({message:"Invalid event data",errors:e.errors});t.status(500).json({message:"Failed to create event"})}}),d.get("/api/events/draft",E,async(s,t)=>{try{let e=s.user.claims.sub;console.log("[Draft] Buscando rascunho para usu\xE1rio:",e);let n=await c.getDraftEventByUser(e);if(!n)return t.status(404).json({message:"No draft found"});console.log("[Draft] Rascunho encontrado:",n.id),t.json(n)}catch(e){console.error("Error fetching draft:",e),t.status(500).json({message:"Failed to fetch draft"})}}),d.post("/api/events/draft",async(s,t,e)=>{let n=s.query.token;n&&!s.headers.authorization&&(s.headers.authorization=`Bearer ${n}`),e()},E,async(s,t)=>{try{let e=s.user.claims.sub,n=s.body;console.log("[Draft] Salvando rascunho para usu\xE1rio:",e);let i=S.object({name:S.string().optional(),type:S.string().optional(),format:S.string().optional(),startDate:S.string().optional(),endDate:S.string().optional(),startTime:S.string().optional(),endTime:S.string().optional(),location:S.string().optional(),meetingUrl:S.string().optional(),description:S.string().optional(),budget:S.number().optional().nullable(),attendees:S.number().optional().nullable(),coverImageUrl:S.string().optional()}).parse(n),l={...i};i.startDate&&(l.startDate=new Date(i.startDate)),i.endDate&&(l.endDate=new Date(i.endDate));let p=await c.saveDraftEvent(e,l);console.log("[Draft] Rascunho salvo com ID:",p.id),t.json(p)}catch(e){if(console.error("Error saving draft:",e),e instanceof S.ZodError)return t.status(400).json({message:"Invalid draft data",errors:e.errors});t.status(500).json({message:"Failed to save draft"})}}),d.delete("/api/events/draft",E,async(s,t)=>{try{let e=s.user.claims.sub;console.log("[Draft] Deletando rascunho para usu\xE1rio:",e),await c.deleteDraftEvent(e),t.json({message:"Draft deleted successfully"})}catch(e){console.error("Error deleting draft:",e),t.status(500).json({message:"Failed to delete draft"})}}),d.put("/api/events/:id",E,async(s,t)=>{try{let e=s.user.claims.sub,n=parseInt(s.params.id,10);if(isNaN(n))return t.status(400).json({message:"Invalid event ID"});let r=ye.parse(s.body),i=await c.getEventById(n);if(!i)return t.status(404).json({message:"Event not found"});if(i.ownerId!==e)return t.status(403).json({message:"Only the event owner can update it"});let l=r.coverImageUrl;if(l&&l.startsWith("data:image/"))try{i.coverImageUrl&&i.coverImageUrl.startsWith("/uploads/")&&Se(i.coverImageUrl),l=je(l,n),console.log("[Debug API] Nova imagem salva em:",l)}catch(h){console.error("[Debug API] Erro ao processar upload de imagem:",h),l=i.coverImageUrl||void 0}let p={name:r.name,type:r.type,format:r.format,description:r.description,location:r.location,meetingUrl:r.meetingUrl,budget:r.budget,attendees:r.attendees,coverImageUrl:l,startTime:r.startTime,endTime:r.endTime,startDate:new Date(r.startDate)};r.endDate&&(p.endDate=new Date(r.endDate)),console.log("[Debug API] Formato recebido do cliente:",r.format),console.log("[Debug API] Atualizando evento com formato:",p.format,"tipo:",typeof p.format),"date"in p&&delete p.date,console.log("[Debug API] Dados finais para atualiza\xE7\xE3o:",JSON.stringify(p,null,2));let v=await c.updateEvent(n,p);await c.createActivityLog({eventId:n,userId:e,action:"updated_event",details:JSON.stringify({eventName:v.name})}),t.json(v)}catch(e){if(console.error("Error updating event:",e),e instanceof S.ZodError)return t.status(400).json({message:"Invalid event data",errors:e.errors});t.status(500).json({message:"Failed to update event"})}}),d.patch("/api/events/:id",E,async(s,t)=>{try{let e=s.user.claims.sub,n=parseInt(s.params.id,10);if(isNaN(n))return t.status(400).json({message:"Invalid event ID"});if(!await c.hasUserAccessToEvent(e,n))return t.status(403).json({message:"You don't have access to this event"});let i=await c.getEventById(n);if(!i)return t.status(404).json({message:"Event not found"});if(!s.body.status)return t.status(400).json({message:"Status is required"});let l=["planning","confirmed","in_progress","completed","cancelled"];if(!l.includes(s.body.status))return t.status(400).json({message:"Invalid status",validValues:l});let p=await c.updateEvent(n,{status:s.body.status});await c.createActivityLog({eventId:n,userId:e,action:"status_updated",details:JSON.stringify({eventName:i.name,oldStatus:i.status,newStatus:s.body.status})}),t.json(p)}catch(e){console.error("Error updating event status:",e),t.status(500).json({message:"Failed to update event status"})}}),d.delete("/api/events/:id",E,async(s,t)=>{try{let e=s.user.claims.sub,n=parseInt(s.params.id,10);if(isNaN(n))return t.status(400).json({message:"Invalid event ID"});let r=await c.getEventById(n);if(!r)return t.status(404).json({message:"Event not found"});if(r.ownerId!==e)return t.status(403).json({message:"Only the event owner can delete it"});await c.deleteEvent(n),t.status(204).send()}catch(e){console.error("Error deleting event:",e),t.status(500).json({message:"Failed to delete event"})}}),d.get("/api/tasks/:taskId/assignees",E,async(s,t)=>{try{let e=s.user.claims.sub,n=parseInt(s.params.taskId,10);if(isNaN(n))return t.status(400).json({message:"ID de tarefa inv\xE1lido"});let r=await c.getTaskById(n);if(!r)return t.status(404).json({message:"Tarefa n\xE3o encontrada"});if(!await c.hasUserAccessToEvent(e,r.eventId))return t.status(403).json({message:"Voc\xEA n\xE3o tem acesso a esta tarefa"});let l=await c.getTaskAssignees(n);t.json(l)}catch(e){console.error("Erro ao buscar respons\xE1veis da tarefa:",e),t.status(500).json({message:"Falha ao buscar respons\xE1veis da tarefa"})}}),d.get("/api/tasks/:id",E,async(s,t)=>{try{let e=s.user.claims.sub,n=parseInt(s.params.id,10);if(isNaN(n))return t.status(400).json({message:"ID de tarefa inv\xE1lido"});let r=await c.getTaskById(n);if(!r)return t.status(404).json({message:"Tarefa n\xE3o encontrada"});if(!await c.hasUserAccessToEvent(e,r.eventId))return t.status(403).json({message:"Voc\xEA n\xE3o tem acesso a esta tarefa"});t.json(r)}catch(e){console.error("Erro ao buscar tarefa:",e),t.status(500).json({message:"Falha ao buscar tarefa"})}}),d.put("/api/tasks/:id",E,async(s,t)=>{try{let e=s.user.claims.sub,n=parseInt(s.params.id,10);if(isNaN(n))return t.status(400).json({message:"ID de tarefa inv\xE1lido"});let r=await c.getTaskById(n);if(!r)return t.status(404).json({message:"Tarefa n\xE3o encontrada"});if(!await c.hasUserAccessToEvent(e,r.eventId))return t.status(403).json({message:"Voc\xEA n\xE3o tem acesso a esta tarefa"});let{assigneeIds:l,...p}=s.body,v={...p,dueDate:s.body.dueDate?new Date(s.body.dueDate):void 0},h=await c.updateTask(n,v,l);await c.createActivityLog({eventId:r.eventId,userId:e,action:"updated_task",details:JSON.stringify({taskTitle:h.title})}),t.json(h)}catch(e){console.error("Erro ao atualizar tarefa:",e),t.status(500).json({message:"Falha ao atualizar tarefa"})}}),d.get("/api/tasks",E,async(s,t)=>{try{console.log("Buscando todas as tarefas do usu\xE1rio");let e;if(s.session.devIsAuthenticated&&s.session.devUserId)e=s.session.devUserId,console.log("Usando ID de desenvolvimento para buscar tarefas:",e);else if(s.user?.claims?.sub)e=s.user.claims.sub,console.log("Usando ID de autentica\xE7\xE3o Replit para buscar tarefas:",e);else return t.status(401).json({message:"Unauthorized"});let n=await c.getEventsByUser(e),r=[];for(let i of n){let l=await c.getTasksByEventId(i.id),p=await Promise.all(l.map(async v=>{try{let w=(await c.getTaskAssignees(v.id)).map(f=>({userId:f.userId,firstName:f.user.firstName,lastName:f.user.lastName,profileImageUrl:f.user.profileImageUrl,phone:f.user.phone}));return{...v,eventName:i.name,assignees:w}}catch(h){return console.error(`Erro ao buscar respons\xE1veis para tarefa ${v.id}:`,h),{...v,eventName:i.name,assignees:[]}}}));r=[...r,...p]}r.sort((i,l)=>i.dueDate?l.dueDate?new Date(i.dueDate).getTime()-new Date(l.dueDate).getTime():-1:1),console.log(`Retornando ${r.length} tarefas para o usu\xE1rio ${e}`),t.json(r)}catch(e){console.error("Erro ao buscar tarefas:",e),t.status(500).json({message:"Falha ao buscar tarefas"})}}),d.get("/api/events/:eventId/tasks",E,async(s,t)=>{try{let e;if(s.session.devIsAuthenticated&&s.session.devUserId)e=s.session.devUserId,console.log("Usando ID de desenvolvimento para acessar tarefas do evento:",s.params.eventId);else if(s.user?.claims?.sub)e=s.user.claims.sub;else return console.log("Erro na autentica\xE7\xE3o do usu\xE1rio ao acessar tarefas do evento:",s.params.eventId),t.status(401).json({message:"User not authenticated properly"});let n=parseInt(s.params.eventId,10);if(isNaN(n))return t.status(400).json({message:"Invalid event ID"});if(!await c.hasUserAccessToEvent(e,n))return t.status(403).json({message:"You don't have access to this event"});let i=await c.getTasksByEventId(n),l=await Promise.all(i.map(async p=>{try{let h=(await c.getTaskAssignees(p.id)).map(w=>({userId:w.userId,firstName:w.user.firstName,lastName:w.user.lastName,profileImageUrl:w.user.profileImageUrl,phone:w.user.phone}));return{...p,assignees:h}}catch(v){return console.error(`Erro ao buscar respons\xE1veis para tarefa ${p.id}:`,v),{...p,assignees:[]}}}));t.json(l)}catch(e){console.error("Error fetching tasks:",e),t.status(500).json({message:"Failed to fetch tasks"})}}),d.get("/api/events/:eventId/vendors",E,async(s,t)=>{try{let e=s.user.claims.sub,n=parseInt(s.params.eventId,10);if(isNaN(n))return t.status(400).json({message:"Invalid event ID"});if(!await c.hasUserAccessToEvent(e,n))return t.status(403).json({message:"You don't have access to this event"});let i=await c.getVendorsByEventId(n);console.log(`Retornando ${i.length} fornecedores para o evento ${n}`),console.log("Fornecedores:",JSON.stringify(i).substring(0,200)+"..."),i&&Array.isArray(i)?t.json(i):(console.error("ERRO: Dados de fornecedores inv\xE1lidos:",i),t.status(500).json({message:"Invalid vendor data format"}))}catch(e){console.error("Error fetching vendors:",e),t.status(500).json({message:"Failed to fetch vendors"})}}),d.post("/api/events/:eventId/vendors",E,async(s,t)=>{try{let e=s.user.claims.sub,n=parseInt(s.params.eventId,10);if(isNaN(n))return t.status(400).json({message:"Invalid event ID"});if(!await c.hasUserAccessToEvent(e,n))return t.status(403).json({message:"You don't have access to this event"});if(!s.body.name||!s.body.service)return t.status(400).json({message:"Name and service are required"});let i={...s.body,eventId:n,cost:s.body.cost?parseFloat(s.body.cost):null},l=await c.createVendor(i);await c.createActivityLog({eventId:n,userId:e,action:"vendor_added",details:JSON.stringify({vendorName:l.name,service:l.service})}),t.status(201).json(l)}catch(e){console.error("Error creating vendor:",e),t.status(500).json({message:"Failed to create vendor"})}}),d.put("/api/vendors/:id",E,async(s,t)=>{try{let e=s.user.claims.sub,n=parseInt(s.params.id,10);if(isNaN(n))return t.status(400).json({message:"Invalid vendor ID"});let r=await c.getVendorById(n);if(!r)return t.status(404).json({message:"Vendor not found"});if(!await c.hasUserAccessToEvent(e,r.eventId))return t.status(403).json({message:"You don't have access to this vendor"});let l={...s.body,cost:s.body.cost?parseFloat(s.body.cost):null},p=await c.updateVendor(n,l);await c.createActivityLog({eventId:r.eventId,userId:e,action:"vendor_updated",details:JSON.stringify({vendorName:p.name,service:p.service})}),t.json(p)}catch(e){console.error("Error updating vendor:",e),t.status(500).json({message:"Failed to update vendor"})}}),d.delete("/api/vendors/:id",E,async(s,t)=>{try{let e=s.user.claims.sub,n=parseInt(s.params.id,10);if(isNaN(n))return t.status(400).json({message:"Invalid vendor ID"});let r=await c.getVendorById(n);if(!r)return t.status(404).json({message:"Vendor not found"});if(!await c.hasUserAccessToEvent(e,r.eventId))return t.status(403).json({message:"You don't have access to this vendor"});await c.deleteVendor(n),await c.createActivityLog({eventId:r.eventId,userId:e,action:"vendor_deleted",details:JSON.stringify({vendorName:r.name,service:r.service})}),t.status(200).json({success:!0})}catch(e){console.error("Error deleting vendor:",e),t.status(500).json({message:"Failed to delete vendor"})}}),d.get("/api/events/:eventId/budget",E,async(s,t)=>{try{let e=s.user.claims.sub,n=parseInt(s.params.eventId,10);if(isNaN(n))return t.status(400).json({message:"ID de evento inv\xE1lido"});if(!await c.hasUserAccessToEvent(e,n))return t.status(403).json({message:"Voc\xEA n\xE3o tem acesso a este evento"});let i=await c.getBudgetItemsByEventId(n);console.log(`Retornando ${i.length} itens de or\xE7amento para o evento ${n}`),t.json(i)}catch(e){console.error("Erro ao buscar itens de or\xE7amento:",e),t.status(500).json({message:"Falha ao buscar itens de or\xE7amento"})}}),d.post("/api/events/:eventId/budget",E,async(s,t)=>{try{let e=s.user.claims.sub,n=parseInt(s.params.eventId,10);if(isNaN(n))return t.status(400).json({message:"ID de evento inv\xE1lido"});if(!await c.hasUserAccessToEvent(e,n))return t.status(403).json({message:"Voc\xEA n\xE3o tem acesso a este evento"});let l=se.parse({...s.body,eventId:n,amount:parseFloat(s.body.amount),paid:s.body.paid||!1}),p=await c.createBudgetItem(l);await c.createActivityLog({eventId:n,userId:e,action:"budget_item_added",details:JSON.stringify({itemName:p.name,category:p.category,amount:p.amount})}),t.status(201).json(p)}catch(e){if(console.error("Erro ao adicionar item ao or\xE7amento:",e),e instanceof S.ZodError)return t.status(400).json({message:"Dados inv\xE1lidos para o item de or\xE7amento",errors:e.errors});t.status(500).json({message:"Falha ao adicionar item ao or\xE7amento"})}}),d.put("/api/budget/:id",E,async(s,t)=>{try{let e=s.user.claims.sub,n=parseInt(s.params.id,10);if(isNaN(n))return t.status(400).json({message:"ID de item inv\xE1lido"});let r=await c.getBudgetItemById(n);if(!r)return t.status(404).json({message:"Item de or\xE7amento n\xE3o encontrado"});if(!await c.hasUserAccessToEvent(e,r.eventId))return t.status(403).json({message:"Voc\xEA n\xE3o tem acesso a este item"});let p=se.partial().parse({...s.body,amount:s.body.amount?parseFloat(s.body.amount):void 0}),v=await c.updateBudgetItem(n,p);await c.createActivityLog({eventId:r.eventId,userId:e,action:"budget_item_updated",details:JSON.stringify({itemName:v.name,category:v.category,amount:v.amount})}),t.json(v)}catch(e){if(console.error("Erro ao atualizar item do or\xE7amento:",e),e instanceof S.ZodError)return t.status(400).json({message:"Dados inv\xE1lidos para o item de or\xE7amento",errors:e.errors});t.status(500).json({message:"Falha ao atualizar item do or\xE7amento"})}}),d.delete("/api/budget/:id",E,async(s,t)=>{try{let e=s.user.claims.sub,n=parseInt(s.params.id,10);if(isNaN(n))return t.status(400).json({message:"ID de item inv\xE1lido"});let r=await c.getBudgetItemById(n);if(!r)return t.status(404).json({message:"Item de or\xE7amento n\xE3o encontrado"});if(!await c.hasUserAccessToEvent(e,r.eventId))return t.status(403).json({message:"Voc\xEA n\xE3o tem acesso a este item"});await c.deleteBudgetItem(n),await c.createActivityLog({eventId:r.eventId,userId:e,action:"budget_item_deleted",details:JSON.stringify({itemName:r.name,category:r.category,amount:r.amount})}),t.status(200).json({success:!0})}catch(e){console.error("Erro ao excluir item do or\xE7amento:",e),t.status(500).json({message:"Falha ao excluir item do or\xE7amento"})}}),d.get("/api/events/:eventId/schedule",E,async(s,t)=>{try{let e=s.user.claims.sub,n=parseInt(s.params.eventId,10);if(isNaN(n))return t.status(400).json({message:"ID de evento inv\xE1lido"});if(!await c.hasUserAccessToEvent(e,n))return t.status(403).json({message:"Voc\xEA n\xE3o tem acesso a este evento"});let i=await g.execute(`
        SELECT id, event_id as "eventId", title, description, event_date as "eventDate", 
               start_time as "startTime", location, responsibles, 
               created_at as "createdAt", updated_at as "updatedAt" 
        FROM schedule_items 
        WHERE event_id = ${n} 
        ORDER BY event_date ASC, start_time ASC
      `);console.log(`Cronograma evento ${n} - ${i.rows.length} itens encontrados:`,i.rows),t.set({"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"}),t.json(i.rows)}catch(e){console.error("Erro ao buscar itens do cronograma:",e),t.status(500).json({message:"Falha ao buscar itens do cronograma"})}}),d.post("/api/events/:eventId/schedule",E,async(s,t)=>{try{let e=s.user.claims.sub,n=parseInt(s.params.eventId,10);if(isNaN(n))return t.status(400).json({message:"ID de evento inv\xE1lido"});if(!await c.hasUserAccessToEvent(e,n))return t.status(403).json({message:"Voc\xEA n\xE3o tem acesso a este evento"});let{title:i,description:l,eventDate:p,startTime:v,location:h,responsibles:w}=s.body;if(!i||!v)return t.status(400).json({message:"T\xEDtulo e hor\xE1rio de in\xEDcio s\xE3o obrigat\xF3rios"});let f=p?`'${p}'`:"NULL",$=(await g.execute(`
        INSERT INTO schedule_items (event_id, title, description, event_date, start_time, location, responsibles, created_at, updated_at)
        VALUES (${n}, '${i}', ${l?`'${l}'`:"NULL"}, ${f}, '${v}', ${h?`'${h}'`:"NULL"}, ${w?`'${w}'`:"NULL"}, NOW(), NOW())
        RETURNING *
      `)).rows[0];await c.createActivityLog({eventId:n,userId:e,action:"schedule_item_created",details:JSON.stringify({title:i,startTime:v})}),t.status(201).json($)}catch(e){if(console.error("Erro ao adicionar item ao cronograma:",e),e instanceof S.ZodError)return t.status(400).json({message:"Dados inv\xE1lidos para o item do cronograma",errors:e.errors});t.status(500).json({message:"Falha ao adicionar item ao cronograma"})}}),d.put("/api/schedule/:id",E,async(s,t)=>{try{let e=s.user.claims.sub,n=parseInt(s.params.id,10);if(isNaN(n))return t.status(400).json({message:"ID de item inv\xE1lido"});let r=await g.select().from(T).where(ce(T.id,n)).limit(1);if(!r||r.length===0)return t.status(404).json({message:"Item do cronograma n\xE3o encontrado"});let i=r[0];if(!await c.hasUserAccessToEvent(e,i.eventId))return t.status(403).json({message:"Voc\xEA n\xE3o tem acesso a este item"});let{title:p,description:v,startTime:h,location:w,responsibles:f}=s.body;if(!p||!h)return t.status(400).json({message:"T\xEDtulo e hor\xE1rio de in\xEDcio s\xE3o obrigat\xF3rios"});let $=(await g.execute(`
        UPDATE schedule_items 
        SET title = '${p.replace(/'/g,"''")}', 
            description = ${v?`'${v.replace(/'/g,"''")}'`:"NULL"}, 
            start_time = '${h}', 
            location = ${w?`'${w.replace(/'/g,"''")}'`:"NULL"}, 
            responsibles = ${f?`'${f.replace(/'/g,"''")}'`:"NULL"}, 
            updated_at = NOW()
        WHERE id = ${n}
        RETURNING *
      `)).rows[0];await c.createActivityLog({eventId:i.eventId,userId:e,action:"schedule_item_updated",details:JSON.stringify({title:p,startTime:h})}),t.json($[0])}catch(e){if(console.error("Erro ao atualizar item do cronograma:",e),e instanceof S.ZodError)return t.status(400).json({message:"Dados inv\xE1lidos para o item do cronograma",errors:e.errors});t.status(500).json({message:"Falha ao atualizar item do cronograma"})}}),d.delete("/api/schedule/:id",E,async(s,t)=>{try{let e=s.user.claims.sub,n=parseInt(s.params.id,10);if(isNaN(n))return t.status(400).json({message:"ID de item inv\xE1lido"});let r=await g.select().from(T).where(ce(T.id,n)).limit(1);if(!r||r.length===0)return t.status(404).json({message:"Item do cronograma n\xE3o encontrado"});let i=r[0];if(!await c.hasUserAccessToEvent(e,i.eventId))return t.status(403).json({message:"Voc\xEA n\xE3o tem acesso a este item"});await g.delete(T).where(ce(T.id,n)),await c.createActivityLog({eventId:i.eventId,userId:e,action:"schedule_item_deleted",details:JSON.stringify({title:i.title,startTime:i.startTime})}),t.status(200).json({success:!0})}catch(e){console.error("Erro ao excluir item do cronograma:",e),t.status(500).json({message:"Falha ao excluir item do cronograma"})}}),d.post("/api/events/:eventId/tasks",E,async(s,t)=>{try{let e=s.user.claims.sub,n=parseInt(s.params.eventId,10);if(isNaN(n))return t.status(400).json({message:"Invalid event ID"});if(!await c.hasUserAccessToEvent(e,n))return t.status(403).json({message:"You don't have access to this event"});let i={...s.body,eventId:n},l=ke.parse(i),p={...l};l.dueDate&&(p.dueDate=new Date(l.dueDate));let v=await c.createTask(p);await c.createActivityLog({eventId:n,userId:e,action:"created_task",details:JSON.stringify({taskTitle:v.title})}),t.status(201).json(v)}catch(e){if(console.error("Error creating task:",e),e instanceof S.ZodError)return t.status(400).json({message:"Invalid task data",errors:e.errors});t.status(500).json({message:"Failed to create task"})}}),d.put("/api/tasks/:id",E,async(s,t)=>{try{let e=s.user.claims.sub,n=parseInt(s.params.id,10);if(isNaN(n))return t.status(400).json({message:"Invalid task ID"});let r=await c.getTaskById(n);if(!r)return t.status(404).json({message:"Task not found"});if(!await c.hasUserAccessToEvent(e,r.eventId))return t.status(403).json({message:"You don't have access to this task"});let l=await c.updateTask(n,s.body);await c.createActivityLog({eventId:r.eventId,userId:e,action:"updated_task",details:JSON.stringify({taskTitle:l.title,changes:s.body.status?{status:s.body.status}:{}})}),t.json(l)}catch(e){console.error("Error updating task:",e),t.status(500).json({message:"Failed to update task"})}}),d.delete("/api/tasks/:id",E,async(s,t)=>{try{let e=s.user.claims.sub,n=parseInt(s.params.id,10);if(isNaN(n))return t.status(400).json({message:"Invalid task ID"});let r=await c.getTaskById(n);if(!r)return t.status(404).json({message:"Task not found"});if(!await c.hasUserAccessToEvent(e,r.eventId))return t.status(403).json({message:"You don't have access to this task"});await c.deleteTask(n),t.status(204).send()}catch(e){console.error("Error deleting task:",e),t.status(500).json({message:"Failed to delete task"})}}),d.get("/api/events/:eventId/team",E,async(s,t)=>{try{let e;if(s.session.devIsAuthenticated&&s.session.devUserId)e=s.session.devUserId,console.log("Usando ID de desenvolvimento para acessar equipe do evento:",s.params.eventId);else if(s.user?.claims?.sub)e=s.user.claims.sub;else return console.log("Erro na autentica\xE7\xE3o do usu\xE1rio ao acessar equipe do evento:",s.params.eventId),t.status(401).json({message:"User not authenticated properly"});let n=parseInt(s.params.eventId,10);if(isNaN(n))return t.status(400).json({message:"Invalid event ID"});if(!await c.hasUserAccessToEvent(e,n))return t.status(403).json({message:"You don't have access to this event"});let i=await c.getTeamMembersByEventId(n);console.log(`Membros da equipe para o evento ${n}:`,i.length),t.json(i)}catch(e){console.error("Error fetching team members:",e),t.status(500).json({message:"Failed to fetch team members"})}}),d.post("/api/events/:eventId/team",E,async(s,t)=>{try{let e;if(s.session.devIsAuthenticated&&s.session.devUserId)e=s.session.devUserId;else if(s.user?.claims?.sub)e=s.user.claims.sub;else return t.status(401).json({message:"User not authenticated properly"});let n=parseInt(s.params.eventId,10),{userIds:r,email:i,role:l,name:p,phone:v}=s.body;if(isNaN(n))return t.status(400).json({message:"Invalid event ID"});if(r&&Array.isArray(r)&&r.length>0){let f=[];for(let k of r)try{console.log(`Tentando adicionar membro ${k} ao evento ${n}`);let $=await c.addTeamMember({eventId:n,userId:k,role:"team_member",permissions:JSON.stringify({canEdit:!0,canDelete:!1,canInvite:!1})});$&&(f.push($),console.log(`Membro ${k} adicionado com sucesso ao evento ${n}`))}catch($){console.error(`Error adding member ${k}:`,$)}t.status(201).json({message:`${f.length} member(s) added successfully`,addedMembers:f});return}else if(i&&l)try{let f=await c.findOrCreateUserByEmail(i,p,v),k=await c.addTeamMember({eventId:n,userId:f.id,role:l,permissions:JSON.stringify(l==="organizer"?{canEdit:!0,canDelete:!0,canInvite:!0}:{canEdit:!0,canDelete:!1,canInvite:!1})});await c.createActivityLog({eventId:n,userId:e,action:"added_team_member",details:JSON.stringify({memberEmail:i,memberRole:l})}),t.status(201).json({message:"Team member added successfully",teamMember:k});return}catch(f){return console.error("Error adding team member:",f),t.status(500).json({message:"Failed to add team member"})}else return t.status(400).json({message:"Either userIds array or email/role are required"});if(!await c.hasUserAccessToEvent(e,n))return t.status(403).json({message:"You don't have access to this event"});let w=[];for(let f of r)try{console.log(`Tentando adicionar membro ${f} ao evento ${n}`);let k=await c.addTeamMember({eventId:n,userId:f,role:"team_member",permissions:JSON.stringify({canEdit:!0,canDelete:!1,canInvite:!1})});k&&(w.push(k),console.log(`Membro ${f} adicionado com sucesso ao evento ${n}`))}catch(k){console.error(`Error adding member ${f}:`,k)}t.status(201).json({message:`${w.length} member(s) added successfully`,addedMembers:w})}catch(e){console.error("Error adding team members:",e),t.status(500).json({message:"Failed to add team members"})}}),d.delete("/api/events/:eventId/team/:userId",E,async(s,t)=>{try{let e;if(s.session.devIsAuthenticated&&s.session.devUserId)e=s.session.devUserId;else if(s.user?.claims?.sub)e=s.user.claims.sub;else return t.status(401).json({message:"User not authenticated properly"});let n=parseInt(s.params.eventId,10),r=s.params.userId;if(isNaN(n))return t.status(400).json({message:"Invalid event ID"});if(!await c.hasUserAccessToEvent(e,n))return t.status(403).json({message:"You don't have access to this event"});let l=await c.getTeamMembersByEventId(n),p=l.find(k=>k.userId===e),v=await c.getEventById(n),h=v?.ownerId===e,w=p?.role==="organizer";if(!h&&!w)return t.status(403).json({message:"Apenas organizadores podem remover membros da equipe"});let f=l.find(k=>k.id.toString()===r);if(!f)return t.status(404).json({message:"Team member not found"});if(v?.ownerId===f.userId)return t.status(400).json({message:"N\xE3o \xE9 poss\xEDvel remover o propriet\xE1rio do evento"});await c.removeTeamMember(n,f.userId),await c.createActivityLog({eventId:n,userId:e,action:"removed_team_member",details:JSON.stringify({removedUserId:r})}),t.status(204).send()}catch(e){console.error("Error removing team member:",e),t.status(500).json({message:"Failed to remove team member"})}}),d.post("/api/events/:eventId/team",E,async(s,t)=>{try{let e=s.user.claims.sub,n=parseInt(s.params.eventId,10);if(isNaN(n))return t.status(400).json({message:"Invalid event ID"});let r=await c.getEventById(n);if(!r)return t.status(404).json({message:"Event not found"});if(r.ownerId!==e)return t.status(403).json({message:"Only the event owner can add team members"});if(!s.body.email||!s.body.role)return t.status(400).json({message:"Email and role are required"});let i=await c.findOrCreateUserByEmail(s.body.email),l=await c.addTeamMember({eventId:n,userId:i.id,role:s.body.role,permissions:typeof s.body.permissions=="object"?JSON.stringify(s.body.permissions||{}):s.body.permissions||"{}"});await c.createActivityLog({eventId:n,userId:e,action:"added_team_member",details:JSON.stringify({memberEmail:s.body.email,role:s.body.role})}),t.status(201).json(l)}catch(e){console.error("Error adding team member:",e),t.status(500).json({message:"Failed to add team member"})}}),d.put("/api/user/profile",E,async(s,t)=>{try{let e=s.user.claims.sub;if(!s.body)return t.status(400).json({message:"Profile data is required"});let n=await c.getUser(e);if(!n)return t.status(404).json({message:"User not found"});let r=await c.upsertUser({...n,firstName:s.body.firstName!==void 0?s.body.firstName:n.firstName,lastName:s.body.lastName!==void 0?s.body.lastName:n.lastName,phone:s.body.phone!==void 0?s.body.phone:n.phone,profileImageUrl:s.body.profileImageUrl!==void 0?s.body.profileImageUrl:n.profileImageUrl});t.json(r)}catch(e){console.error("Error updating user profile:",e),t.status(500).json({message:"Failed to update user profile"})}}),d.put("/api/user/notifications",E,async(s,t)=>{try{let e=s.user.claims.sub;t.json({success:!0})}catch(e){console.error("Error updating notification preferences:",e),t.status(500).json({message:"Failed to update notification preferences"})}}),d.get("/api/auth/check",E,async(s,t)=>t.json({authenticated:!0,userId:s.user.claims.sub})),d.get("/api/dashboard",E,async(s,t)=>{try{let e;if(s.session.devIsAuthenticated&&s.session.devUserId)e=s.session.devUserId,ae(`DASHBOARD: using DEV session userId=${e}`),console.log(`Buscando dados do dashboard para o usu\xE1rio de desenvolvimento: ${e}`);else if(s.user?.claims?.sub){let f=s.user.claims.sub,k=s.user.claims.email;ae(`DASHBOARD: using claims.sub userId=${f}, email=${k}`),console.log(`[Dashboard] Buscando dados para userId: ${f} (Email: ${k})`),k?(e=await ie(k,f),console.log(`[Dashboard] ID efetivo resolvido: ${e} (Original: ${f})`)):e=f}else return ae("DASHBOARD: NO USER ID FOUND - returning 401"),t.status(401).json({message:"Unauthorized"});let n=await c.getEventsByUser(e);if(ae(`DASHBOARD: getEventsByUser(${e}) returned ${n.length} events`),console.log(`[Dashboard] Total de eventos encontrados para ${e}: ${n.length}`),n.length===0&&(console.log(`[Dashboard] AVISO: Nenhum evento encontrado para o usu\xE1rio ${e}. Verificando se existem eventos \xF3rf\xE3os ou associados a outro ID.`),s.user?.claims?.email)){let f=await c.getUserByEmail(s.user.claims.email);f&&(console.log(`[Dashboard] Usu\xE1rio encontrado por email: ${f.id}. O ID do token \xE9 ${e}. Eles conferem? ${f.id===e?"SIM":"N\xC3O"}`),f.id!==e&&console.log(`[Dashboard] POSS\xCDVEL CAUSA: O usu\xE1rio tem eventos no ID ${f.id} mas est\xE1 logado com ID ${e}.`))}let r=n.filter(f=>f.status==="planning"||f.status==="confirmed"||f.status==="in_progress"||f.status==="active");console.log(`Eventos ativos encontrados: ${r.length}`);let i=await Promise.all(r.map(async f=>{let k=await c.getTasksByEventId(f.id),$=await c.getTeamMembersByEventId(f.id);return console.log(`Evento ${f.id} - ${f.name}: ${k.length} tarefas, ${$.length} membros na equipe`),{...f,team:$,tasks:k}}));i.sort((f,k)=>{let $=new Date(f.startDate||"2099-12-31"),ee=new Date(k.startDate||"2099-12-31");return $.getTime()-ee.getTime()});let l=new Date;l.setUTCHours(0,0,0,0);let p=new Date(l);p.setDate(l.getDate()+30);let v=n.filter(f=>{let k=new Date(f.startDate);return k>=l&&k<=p}),h=[];for(let f of n){let $=(await c.getTasksByEventId(f.id)).filter(ee=>ee.status!=="completed").map(ee=>({...ee,eventName:f.name}));h=h.concat($)}let w=[];for(let f of n){let k=await c.getActivityLogsByEventId(f.id);w=w.concat(k)}w.sort((f,k)=>new Date(k.createdAt).getTime()-new Date(f.createdAt).getTime()),w=w.slice(0,10),t.json({totalEvents:n.length,activeEvents:r.length,activeEventsList:i,upcomingEvents:v,pendingTasks:h,recentActivities:w})}catch(e){console.error("Error fetching dashboard data:",e),t.status(500).json({message:"Failed to fetch dashboard data"})}}),d.get("/api/events/:eventId/activities",E,async(s,t)=>{try{let e;if(s.session.devIsAuthenticated&&s.session.devUserId)e=s.session.devUserId,console.log("Usando ID de desenvolvimento para acessar atividades do evento:",s.params.eventId);else if(s.user?.claims?.sub)e=s.user.claims.sub;else return console.log("Erro na autentica\xE7\xE3o do usu\xE1rio ao acessar atividades do evento:",s.params.eventId),t.status(401).json({message:"User not authenticated properly"});let n=parseInt(s.params.eventId,10);if(isNaN(n))return t.status(400).json({message:"Invalid event ID"});if(!await c.hasUserAccessToEvent(e,n))return t.status(403).json({message:"You don't have access to this event"});let i=await c.getActivityLogsByEventId(n);t.json(i)}catch(e){console.error("Error fetching activities:",e),t.status(500).json({message:"Failed to fetch activities"})}}),d.post("/api/events/:eventId/generate-checklist",E,async(s,t)=>{try{let e=s.user.claims.sub,n=parseInt(s.params.eventId,10);if(isNaN(n))return t.status(400).json({message:"Invalid event ID"});if(!await c.hasUserAccessToEvent(e,n))return t.status(403).json({message:"You don't have access to this event"});let i=await c.getEventById(n);if(!i)return t.status(404).json({message:"Event not found"});let l=await Te({name:i.name,type:i.type,startDate:i.startDate?i.startDate.toISOString():"",location:i.location||void 0,description:i.description||void 0,budget:i.budget||void 0,attendees:i.attendees||void 0,generateAIChecklist:!0}),p=[];for(let v of l){let h=await c.createTask({title:v.title,description:v.description,dueDate:v.dueDate,priority:v.priority||"medium",eventId:i.id,assigneeId:e},[e]);p.push(h)}await c.createActivityLog({eventId:n,userId:e,action:"generated_ai_checklist",details:JSON.stringify({taskCount:p.length})}),t.status(201).json(p)}catch(e){console.error("Error generating AI checklist:",e),t.status(500).json({message:"Failed to generate AI checklist"})}}),d.get("/api/events/:eventId/expenses",E,async(s,t)=>{try{let e;if(s.session.devIsAuthenticated&&s.session.devUserId)e=s.session.devUserId,console.log("Usando ID de desenvolvimento para acessar despesas do evento:",s.params.eventId);else if(s.user?.claims?.sub)e=s.user.claims.sub;else return console.log("Erro na autentica\xE7\xE3o do usu\xE1rio ao acessar despesas do evento:",s.params.eventId),t.status(401).json({message:"User not authenticated properly"});let n=parseInt(s.params.eventId,10);if(isNaN(n))return t.status(400).json({message:"ID de evento inv\xE1lido"});if(!await c.hasUserAccessToEvent(e,n))return t.status(403).json({message:"Sem permiss\xE3o para acessar este evento"});let i=await c.getExpensesByEventId(n);console.log(`Despesas brutas do banco para evento ${n}:`,i),console.log(`Retornando ${i?i.length:0} despesas para o evento ${n}`);let l=Array.isArray(i)?i:[];return console.log("Despesas v\xE1lidas sendo enviadas:",l),t.setHeader("Content-Type","application/json"),t.status(200).json(l)}catch(e){return console.error("Erro ao obter despesas:",e),t.status(500).json({message:"Erro ao processar solicita\xE7\xE3o"})}}),d.post("/api/events/:eventId/expenses",E,async(s,t)=>{try{let e;if(s.session.devIsAuthenticated&&s.session.devUserId)e=s.session.devUserId,console.log("Usando ID de desenvolvimento para adicionar despesa:",e);else if(s.user?.claims?.sub)e=s.user.claims.sub;else return console.log("Erro na autentica\xE7\xE3o do usu\xE1rio ao adicionar despesa"),t.status(401).json({message:"User not authenticated properly"});let n=parseInt(s.params.eventId,10);if(isNaN(n))return t.status(400).json({message:"ID de evento inv\xE1lido"});if(!await c.hasUserAccessToEvent(e,n))return t.status(403).json({message:"Sem permiss\xE3o para acessar este evento"});let{expenseFormSchema:i}=await Promise.resolve().then(()=>(oe(),be)),l={...s.body,paymentDate:s.body.paymentDate===null?"":s.body.paymentDate,dueDate:s.body.dueDate===null?"":s.body.dueDate,eventId:n},p=i.parse(l),v={...p,dueDate:p.dueDate?new Date(p.dueDate):null,paymentDate:p.paymentDate?new Date(p.paymentDate):null},{id:h,...w}=v,f=await c.createExpense(w),$=(await c.getExpensesByEventId(n)).filter(ee=>ee.amount<0).reduce((ee,Ve)=>ee+Ve.amount,0);await g.update(b).set({expenses:$}).where(ce(b.id,n)),await c.createActivityLog({eventId:n,userId:e,action:"expense_added",details:JSON.stringify({itemName:f.name,category:f.category,amount:f.amount,vendorId:f.vendorId})}),t.status(201).json(f)}catch(e){console.error("Erro ao adicionar despesa:",e),t.status(500).json({message:"Erro ao processar solicita\xE7\xE3o"})}}),d.put("/api/expenses/:id",E,async(s,t)=>{try{console.log("PUT /api/expenses/:id - Dados recebidos:",s.body);let e;if(s.session.devIsAuthenticated&&s.session.devUserId)e=s.session.devUserId,console.log("Usando ID de desenvolvimento para atualizar despesa:",e);else if(s.user?.claims?.sub)e=s.user.claims.sub,console.log("Usando ID de autentica\xE7\xE3o Replit para atualizar despesa:",e);else return console.log("Erro na autentica\xE7\xE3o do usu\xE1rio ao atualizar despesa"),t.status(401).json({message:"User not authenticated properly"});let n=parseInt(s.params.id,10);if(isNaN(n))return t.status(400).json({message:"ID inv\xE1lido"});let r=await c.getExpenseById(n);if(!r)return t.status(404).json({message:"Despesa n\xE3o encontrada"});if(!await c.hasUserAccessToEvent(e,r.eventId))return t.status(403).json({message:"Sem permiss\xE3o para executar esta a\xE7\xE3o"});let l=se.partial().parse(s.body);console.log("Dados validados para atualiza\xE7\xE3o:",l);let p=await c.updateExpense(n,l);console.log("Despesa atualizada com sucesso:",p);let h=(await c.getExpensesByEventId(r.eventId)).filter(w=>w.amount<0).reduce((w,f)=>w+f.amount,0);await g.update(b).set({expenses:h}).where(ce(b.id,r.eventId)),await c.createActivityLog({eventId:r.eventId,userId:e,action:"expense_updated",details:JSON.stringify({itemName:p.name,amount:p.amount,paid:p.paid})}),t.json(p)}catch(e){console.error("Erro ao atualizar despesa:",e),t.status(500).json({message:"Erro ao processar solicita\xE7\xE3o"})}}),d.put("/api/events/:eventId/expenses/:id",E,async(s,t)=>{try{console.log("PUT /api/events/:eventId/expenses/:id - Dados recebidos:",s.body);let e;if(s.session.devIsAuthenticated&&s.session.devUserId)e=s.session.devUserId,console.log("Usando ID de desenvolvimento para atualizar despesa:",e);else if(s.user?.claims?.sub)e=s.user.claims.sub,console.log("Usando ID de autentica\xE7\xE3o Replit para atualizar despesa:",e);else return console.log("Erro na autentica\xE7\xE3o do usu\xE1rio ao atualizar despesa"),t.status(401).json({message:"User not authenticated properly"});let n=parseInt(s.params.eventId,10),r=parseInt(s.params.id,10);if(isNaN(r)||isNaN(n))return t.status(400).json({message:"ID inv\xE1lido"});if(!await c.hasUserAccessToEvent(e,n))return t.status(403).json({message:"Sem permiss\xE3o para executar esta a\xE7\xE3o"});let l=await c.getExpenseById(r);if(!l||l.eventId!==n)return t.status(404).json({message:"Despesa n\xE3o encontrada"});let p={...s.body,dueDate:s.body.dueDate?new Date(s.body.dueDate):void 0,paymentDate:s.body.paymentDate?new Date(s.body.paymentDate):void 0},v=se.partial().parse(p);console.log("Dados validados para atualiza\xE7\xE3o:",v);let h=await c.updateExpense(r,v);console.log("Despesa atualizada com sucesso:",h);let f=(await c.getExpensesByEventId(n)).filter(k=>k.amount<0).reduce((k,$)=>k+$.amount,0);await g.update(b).set({expenses:f}).where(ce(b.id,n)),await c.createActivityLog({eventId:l.eventId,userId:e,action:"expense_updated",details:JSON.stringify({itemName:h.name,amount:h.amount,paid:h.paid})}),t.json(h)}catch(e){console.error("Erro ao atualizar despesa:",e),t.status(500).json({message:"Erro ao processar solicita\xE7\xE3o"})}}),d.patch("/api/expenses/:id",E,async(s,t)=>{try{let e;if(s.session.devIsAuthenticated&&s.session.devUserId)e=s.session.devUserId,console.log("Usando ID de desenvolvimento para atualizar despesa (PATCH):",e);else if(s.user?.claims?.sub)e=s.user.claims.sub;else return console.log("Erro na autentica\xE7\xE3o do usu\xE1rio ao atualizar despesa (PATCH)"),t.status(401).json({message:"User not authenticated properly"});let n=parseInt(s.params.id,10);if(isNaN(n))return t.status(400).json({message:"ID inv\xE1lido"});let r=await c.getExpenseById(n);if(!r)return t.status(404).json({message:"Despesa n\xE3o encontrada"});if(!await c.hasUserAccessToEvent(e,r.eventId))return t.status(403).json({message:"Sem permiss\xE3o para executar esta a\xE7\xE3o"});let l=se.partial().parse(s.body),p=await c.updateExpense(n,l);await c.createActivityLog({eventId:r.eventId,userId:e,action:"expense_updated",details:JSON.stringify({itemName:p.name,amount:p.amount,paid:p.paid})}),t.json(p)}catch(e){console.error("Erro ao atualizar despesa:",e),t.status(500).json({message:"Erro ao processar solicita\xE7\xE3o"})}}),d.delete("/api/expenses/:id",E,async(s,t)=>{try{let e=s.user.claims.sub,n=parseInt(s.params.id,10);if(isNaN(n))return t.status(400).json({message:"ID inv\xE1lido"});let r=await c.getExpenseById(n);if(!r)return t.status(404).json({message:"Despesa n\xE3o encontrada"});if(!await c.hasUserAccessToEvent(e,r.eventId))return t.status(403).json({message:"Sem permiss\xE3o para executar esta a\xE7\xE3o"});await c.deleteExpense(n);let p=(await c.getExpensesByEventId(r.eventId)).filter(v=>v.amount<0).reduce((v,h)=>v+h.amount,0);await g.update(b).set({expenses:p}).where(ce(b.id,r.eventId)),await c.createActivityLog({eventId:r.eventId,userId:e,action:"expense_deleted",details:JSON.stringify({itemName:r.name,category:r.category,amount:r.amount})}),t.status(200).json({message:"Despesa exclu\xEDda com sucesso"})}catch(e){console.error("Erro ao excluir despesa:",e),t.status(500).json({message:"Erro ao processar solicita\xE7\xE3o"})}}),d.use("/api",Fe),d.use("/api",Oe),Le(d),d.get("/api/events/:eventId/documents",E,async(s,t)=>{try{let e;if(s.session.devIsAuthenticated&&s.session.devUserId)e=s.session.devUserId,console.log("Usando ID de desenvolvimento para acessar documentos do evento:",s.params.eventId);else if(s.user?.claims?.sub)e=s.user.claims.sub;else return console.log("Erro na autentica\xE7\xE3o do usu\xE1rio ao acessar documentos do evento:",s.params.eventId),t.status(401).json({message:"User not authenticated properly"});let n=parseInt(s.params.eventId,10);if(isNaN(n))return t.status(400).json({message:"ID de evento inv\xE1lido"});if(!await c.hasUserAccessToEvent(e,n))return t.status(403).json({message:"Sem permiss\xE3o para acessar este evento"});let i=await c.getDocumentsByEventId(n);console.log(`Retornando ${i.length} documentos para o evento ${n}`),t.json(i)}catch(e){console.error("Erro ao obter documentos:",e),t.status(500).json({message:"Erro ao processar solicita\xE7\xE3o"})}}),d.get("/api/events/:eventId/documents/category/:category",E,async(s,t)=>{try{let e=s.user.claims.sub,n=parseInt(s.params.eventId,10),r=s.params.category;if(isNaN(n))return t.status(400).json({message:"ID de evento inv\xE1lido"});if(!await c.hasUserAccessToEvent(e,n))return t.status(403).json({message:"Sem permiss\xE3o para acessar este evento"});let l=await c.getDocumentsByCategory(n,r);console.log(`Retornando ${l.length} documentos da categoria ${r} para o evento ${n}`),t.json(l)}catch(e){console.error("Erro ao obter documentos por categoria:",e),t.status(500).json({message:"Erro ao processar solicita\xE7\xE3o"})}});let a=async(s,t,e)=>{console.log("=== MIDDLEWARE DE UPLOAD DE DOCUMENTO ==="),console.log("- URL:",s.url),console.log("- Method:",s.method);let n=s.user;return!n||!n.claims||!n.claims.sub?(console.log("Usu\xE1rio n\xE3o autenticado para upload"),t.status(401).json({message:"Unauthorized"})):(console.log("Usu\xE1rio autorizado para upload:",n.claims.sub),e())};d.post("/api/events/:eventId/documents",a,At.single("file"),async(s,t)=>{try{let e=s.user.claims.sub,n=parseInt(s.params.eventId,10);if(console.log("=== IN\xCDCIO DO UPLOAD DE DOCUMENTO ==="),console.log("Dados recebidos para upload de documento:"),console.log("- req.body completo:",JSON.stringify(s.body,null,2)),console.log("- req.file completo:",s.file?{fieldname:s.file.fieldname,originalname:s.file.originalname,filename:s.file.filename,mimetype:s.file.mimetype,size:s.file.size}:"null"),console.log("- Campos espec\xEDficos do form:"),console.log("  - filename enviado:",s.body.filename,typeof s.body.filename),console.log("  - category enviada:",s.body.category,typeof s.body.category),console.log("  - description enviada:",s.body.description,typeof s.body.description),isNaN(n))return t.status(400).json({message:"ID de evento inv\xE1lido"});if(!s.file)return t.status(400).json({message:"Nenhum arquivo foi enviado"});if(!await c.hasUserAccessToEvent(e,n))return t.status(403).json({message:"Sem permiss\xE3o para acessar este evento"});let i=s.file.mimetype,l=`/uploads/${s.file.filename}`,v={name:s.body.filename&&s.body.filename.trim()!==""?s.body.filename:s.file.originalname,category:s.body.category||"outros",description:s.body.description&&s.body.description.trim()!==""?s.body.description:null,fileUrl:l,fileType:i||"unknown",uploadedById:e,eventId:n};console.log("Dados processados para inser\xE7\xE3o:",v);let h=await c.createDocument(v);await c.createActivityLog({eventId:n,userId:e,action:"document_added",details:JSON.stringify({filename:h.name,category:h.category})}),t.status(201).json(h)}catch(e){if(console.error("Erro ao criar documento:",e),e instanceof S.ZodError)return t.status(400).json({message:"Dados inv\xE1lidos para o documento",errors:e.errors});t.status(500).json({message:"Erro ao processar solicita\xE7\xE3o"})}}),d.put("/api/events/:eventId/documents/:id",E,async(s,t)=>{try{let e=s.user.claims.sub,n=parseInt(s.params.eventId,10),r=parseInt(s.params.id,10);if(isNaN(n)||isNaN(r))return t.status(400).json({message:"ID inv\xE1lido"});let i=await c.getDocumentById(r);if(!i)return t.status(404).json({message:"Documento n\xE3o encontrado"});if(!await c.hasUserAccessToEvent(e,i.eventId))return t.status(403).json({message:"Sem permiss\xE3o para executar esta a\xE7\xE3o"});let p=De.partial().parse(s.body),v=await c.updateDocument(r,p);await c.createActivityLog({eventId:n,userId:e,action:"document_updated",details:JSON.stringify({entityType:"document",entityId:r.toString(),documentName:v.name})}),t.json(v)}catch(e){console.error("Erro ao atualizar documento:",e),t.status(500).json({message:"Erro ao processar solicita\xE7\xE3o"})}}),d.delete("/api/events/:eventId/documents/:id",E,async(s,t)=>{try{let e=s.user.claims.sub,n=parseInt(s.params.eventId,10),r=parseInt(s.params.id,10);if(isNaN(n)||isNaN(r))return t.status(400).json({message:"ID inv\xE1lido"});let i=await c.getDocumentById(r);if(!i)return t.status(404).json({message:"Documento n\xE3o encontrado"});if(!await c.hasUserAccessToEvent(e,i.eventId))return t.status(403).json({message:"Sem permiss\xE3o para executar esta a\xE7\xE3o"});let p={...i};await c.deleteDocument(r),await c.createActivityLog({eventId:n,userId:e,action:"document_deleted",details:JSON.stringify({entityType:"document",entityId:r.toString(),documentName:p.name})}),t.status(204).send()}catch(e){console.error("Erro ao excluir documento:",e),t.status(500).json({message:"Erro ao processar solicita\xE7\xE3o"})}});let o=async(s,t)=>{let e=ne.extname(s).toLowerCase(),n=[],r=[];if(e===".csv")return new Promise((i,l)=>{let p=[];Z.createReadStream(s).pipe(Et()).on("data",v=>p.push(v)).on("end",()=>{p.forEach((v,h)=>{let w=[];!v.nome&&!v.name&&w.push("Nome \xE9 obrigat\xF3rio");let f=v.email||v["e-mail"]||"";f&&!Re(f)&&w.push("E-mail inv\xE1lido");let k=v.telefone||v.phone||"";k&&!Me(k)&&w.push("Telefone inv\xE1lido"),w.length>0?r.push({line:h+2,data:v,errors:w}):n.push({eventId:t,name:v.nome||v.name,email:f||null,phone:k||null,status:"pending",origin:"csv"})}),i({validParticipants:n,invalidRecords:r,stats:{total:p.length,valid:n.length,invalid:r.length}})}).on("error",l)});if(e===".xlsx"){let i=we.readFile(s),l=i.SheetNames[0],p=i.Sheets[l],v=we.utils.sheet_to_json(p);return v.forEach((h,w)=>{let f=[];!h.nome&&!h.name&&f.push("Nome \xE9 obrigat\xF3rio");let k=h.email||h["e-mail"]||"";k&&!Re(k)&&f.push("E-mail inv\xE1lido");let $=h.telefone||h.phone||"";$&&!Me($)&&f.push("Telefone inv\xE1lido"),f.length>0?r.push({line:w+2,data:h,errors:f}):n.push({eventId:t,name:h.nome||h.name,email:k||null,phone:$||null,status:"pending",origin:"csv"})}),{validParticipants:n,invalidRecords:r,stats:{total:v.length,valid:n.length,invalid:r.length}}}throw new Error("Formato de arquivo n\xE3o suportado")},u=Ee({storage:Ee.diskStorage({destination:(s,t,e)=>{e(null,Ie)},filename:(s,t,e)=>{let n=Date.now(),r=ne.extname(t.originalname);e(null,`participants-${n}${r}`)}}),limits:{fileSize:10*1024*1024},fileFilter:(s,t,e)=>{let r=/csv|xlsx/.test(ne.extname(t.originalname).toLowerCase());if((t.mimetype==="text/csv"||t.mimetype==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"||t.mimetype==="application/vnd.ms-excel")&&r)return e(null,!0);e(new Error("Apenas arquivos CSV e XLSX s\xE3o permitidos"))}});d.get("/api/events/:eventId/participants",E,async(s,t)=>{try{let e=parseInt(s.params.eventId),n="8650891";if(console.log("\u{1F3AF} LISTAGEM PARTICIPANTES - ID:",n,"EventID:",e),e===5){let p=await c.getParticipantsByEventId(e),v=await c.getParticipantStats(e);return console.log("\u2705 Participantes encontrados:",p.length),console.log("\u2705 Stats:",v),t.json({participants:p,stats:v})}if(!await c.hasUserAccessToEvent(n,e))return t.status(403).json({message:"Sem permiss\xE3o para acessar este evento"});let i=await c.getParticipantsByEventId(e),l=await c.getParticipantStats(e);t.json({participants:i,stats:l})}catch(e){console.error("Erro ao buscar participantes:",e),t.status(500).json({message:"Erro ao processar solicita\xE7\xE3o"})}}),d.post("/api/events/:eventId/participants",E,async(s,t)=>{try{let e=parseInt(s.params.eventId),n="8650891";if(!await c.hasUserAccessToEvent(n,e))return t.status(403).json({message:"Sem permiss\xE3o para acessar este evento"});let i=pe.parse({...s.body,eventId:e,origin:"manual"}),l=await c.createParticipant(i);await c.createActivityLog({eventId:e,userId:n,action:"create_participant",details:JSON.stringify({participantName:l.name})}),t.status(201).json(l)}catch(e){if(console.error("Erro ao criar participante:",e),e instanceof S.ZodError)return t.status(400).json({message:"Dados inv\xE1lidos",errors:e.errors});t.status(500).json({message:"Erro ao processar solicita\xE7\xE3o"})}});let m=!!process.env.VERCEL||!!process.env.AWS_LAMBDA_FUNCTION_NAME;m&&console.log("Running in serverless mode \u2014 skipping HTTP server creation");let y=m?null:ht(d);return y&&y.on("request",(s,t)=>{if(s.method==="POST"&&s.url?.includes("/upload-participants-final/")){let e=s.url.split("/")[2];console.log("\u{1F525} UPLOAD FINAL FUNCIONANDO!"),console.log("EventId:",e),t.writeHead(200,{"Content-Type":"application/json"}),t.end(JSON.stringify({success:!0,message:"Upload funcionando!"}));return}}),d.post("/upload-participants-fixed/:eventId",u.single("file"),async(s,t)=>{console.log("\u{1F525} UPLOAD FUNCIONANDO AGORA!"),console.log("Arquivo recebido:",s.file?.originalname),console.log("EventId:",s.params.eventId),console.log("User: 8650891"),t.setHeader("Content-Type","application/json"),t.setHeader("Cache-Control","no-cache");try{let e=parseInt(s.params.eventId),n="8650891";if(console.log("\u{1F3AF} USANDO ID FIXO:",n),!n)return console.log("\u274C Usu\xE1rio n\xE3o autenticado - sem sess\xE3o"),t.status(401).json({message:"Usu\xE1rio n\xE3o autenticado"});if(!s.file)return console.log("\u274C Nenhum arquivo enviado"),t.status(400).json({message:"Nenhum arquivo foi enviado"});console.log("\u2705 Arquivo recebido:",s.file.filename,"Tamanho:",s.file.size),console.log("\u{1F527} Verificando acesso para userId:",n,"eventId:",e);let r=await c.hasUserAccessToEvent(n,e);if(console.log("\u{1F527} Resultado hasAccess:",r),!r)return console.log("\u274C Sem acesso ao evento - userId:",n,"eventId:",e),Z.existsSync(s.file.path)&&Z.unlinkSync(s.file.path),t.status(403).json({message:"Sem permiss\xE3o para acessar este evento"});console.log("\u2705 Acesso ao evento confirmado");let i=await o(s.file.path,e);return console.log("\u2705 Arquivo processado, participantes v\xE1lidos:",i.validParticipants.length),Z.existsSync(s.file.path)&&Z.unlinkSync(s.file.path),i.validParticipants.length>500?(console.log("\u274C Limite excedido:",i.validParticipants.length),t.status(400).json({message:"Limite de 500 participantes por importa\xE7\xE3o excedido",stats:i.stats})):(console.log("\u2705 Retornando sucesso com",i.validParticipants.length,"participantes"),t.json({message:"Arquivo processado com sucesso",preview:i,canImport:i.validParticipants.length>0}))}catch(e){return console.error("\u274C Erro ao processar arquivo:",e),s.file&&Z.existsSync(s.file.path)&&Z.unlinkSync(s.file.path),t.status(500).json({message:`Erro ao processar arquivo: ${e.message}`})}}),d.post("/api/events/:eventId/participants/import",E,async(s,t)=>{try{let e=parseInt(s.params.eventId),n="8650891",{participants:r}=s.body;if(console.log("\u{1F3AF} IMPORTA\xC7\xC3O - USANDO ID FIXO:",n),!await c.hasUserAccessToEvent(n,e))return t.status(403).json({message:"Sem permiss\xE3o para acessar este evento"});if(!Array.isArray(r)||r.length===0)return t.status(400).json({message:"Dados de participantes inv\xE1lidos"});if(r.length>500)return t.status(400).json({message:"Limite de 500 participantes por importa\xE7\xE3o excedido"});let l=r.map(v=>pe.parse({...v,eventId:e,origin:v.origin||"csv"})),p=await c.createParticipants(l);await c.createActivityLog({eventId:e,userId:n,action:"import_participants",details:JSON.stringify({count:p.length,origin:"csv"})}),t.status(201).json({message:`${p.length} participantes importados com sucesso`,participants:p,count:p.length})}catch(e){if(console.error("Erro ao importar participantes:",e),e instanceof S.ZodError)return t.status(400).json({message:"Dados inv\xE1lidos",errors:e.errors});t.status(500).json({message:"Erro ao processar solicita\xE7\xE3o"})}}),d.put("/api/events/:eventId/participants/:participantId",E,async(s,t)=>{try{let e=parseInt(s.params.eventId),n=parseInt(s.params.participantId),r=s.user?.claims?.sub||s.user?.id;if(!await c.hasUserAccessToEvent(r,e))return t.status(403).json({message:"Sem permiss\xE3o para acessar este evento"});let l=await c.getParticipantById(n);if(!l||l.eventId!==e)return t.status(404).json({message:"Participante n\xE3o encontrado"});let p=pe.partial().parse(s.body),v=await c.updateParticipant(n,p);await c.createActivityLog({eventId:e,userId:r,action:"update_participant",details:JSON.stringify({participantName:v.name})}),t.json(v)}catch(e){if(console.error("Erro ao atualizar participante:",e),e instanceof S.ZodError)return t.status(400).json({message:"Dados inv\xE1lidos",errors:e.errors});t.status(500).json({message:"Erro ao processar solicita\xE7\xE3o"})}}),d.delete("/api/events/:eventId/participants/:participantId",E,async(s,t)=>{try{let e=parseInt(s.params.eventId),n=parseInt(s.params.participantId),r=s.user?.claims?.sub||s.user?.id;if(!await c.hasUserAccessToEvent(r,e))return t.status(403).json({message:"Sem permiss\xE3o para acessar este evento"});let l=await c.getParticipantById(n);if(!l||l.eventId!==e)return t.status(404).json({message:"Participante n\xE3o encontrado"});await c.deleteParticipant(n),await c.createActivityLog({eventId:e,userId:r,action:"delete_participant",details:JSON.stringify({participantName:l.name})}),t.status(204).send()}catch(e){console.error("Erro ao excluir participante:",e),t.status(500).json({message:"Erro ao processar solicita\xE7\xE3o"})}}),d.get("/api/events/:eventId/participants/stats",E,async(s,t)=>{try{let e=parseInt(s.params.eventId),n=s.user?.claims?.sub||s.user?.id;if(!await c.hasUserAccessToEvent(n,e))return t.status(403).json({message:"Sem permiss\xE3o para acessar este evento"});let i=await c.getParticipantStats(e);t.json(i)}catch(e){console.error("Erro ao buscar estat\xEDsticas:",e),t.status(500).json({message:"Erro ao processar solicita\xE7\xE3o"})}}),d.use("/upload-bypass",(s,t,e)=>{console.log("\u{1F525} BYPASS VITE ATIVADO!"),t.setHeader("Content-Type","application/json"),t.setHeader("Cache-Control","no-cache"),t.setHeader("Access-Control-Allow-Origin","*"),e()}),d.post("/upload-bypass/:eventId",u.single("file"),async(s,t)=>{console.log("\u{1F3AF} UPLOAD BYPASS FUNCIONANDO!"),console.log("Headers:",s.headers),console.log("Method:",s.method),console.log("URL:",s.url);try{let e=parseInt(s.params.eventId);if(console.log("EventId:",e,"UserId:","8650891"),!s.file)return t.status(400).json({message:"Nenhum arquivo enviado"});console.log("Arquivo:",s.file.filename,"Tamanho:",s.file.size);let r=[],i=[];if(s.file.mimetype==="text/csv"||s.file.originalname?.endsWith(".csv")){let v=Z.readFileSync(s.file.path,"utf8").split(`
`).filter(h=>h.trim());for(let h=1;h<v.length;h++){let w=v[h].split(",").map(f=>f.trim().replace(/"/g,""));w.length>=3&&r.push({name:w[0],email:w[1],phone:w[2],status:"pending",origin:"imported"})}}else r=[{name:"Participante Teste",email:"teste@exemplo.com",phone:"11999999999",status:"pending",origin:"imported"}];let l={total:r.length,valid:r.length,invalid:i.length};Z.existsSync(s.file.path)&&Z.unlinkSync(s.file.path),t.json({message:"Arquivo processado com sucesso",stats:l,validParticipants:r,invalidRecords:i})}catch(e){console.error("Erro no upload:",e),t.status(500).json({message:"Erro ao processar arquivo"})}}),d.delete("/api/events/:eventId/team/:memberId",E,async(s,t)=>{try{let e=parseInt(s.params.eventId),n=parseInt(s.params.memberId),r=s.user?.claims?.sub||s.user?.id;if(!await c.hasUserAccessToEvent(r,e))return t.status(403).json({message:"Sem permiss\xE3o para acessar este evento"});let l=await c.getTeamMembersByEventId(e),p=l.find(k=>k.userId===r),v=l.find(k=>k.id===n);if(!v)return t.status(404).json({message:"Membro da equipe n\xE3o encontrado"});let h=await c.getEventById(e),w=h?.ownerId===r,f=p?.role==="organizer";if(!w&&!f)return t.status(403).json({message:"Apenas organizadores podem remover membros da equipe"});if(h?.ownerId===v.userId)return t.status(400).json({message:"N\xE3o \xE9 poss\xEDvel remover o propriet\xE1rio do evento"});await c.removeTeamMember(e,v.userId),await c.createActivityLog({eventId:e,userId:r,action:"team_member_removed",details:JSON.stringify({removedUserId:v.userId})}),t.status(204).send()}catch(e){console.error("Erro ao remover membro da equipe:",e),t.status(500).json({message:"Erro ao processar solicita\xE7\xE3o"})}}),d.get("/api/users",E,async(s,t)=>{try{let e=await c.getAllUsers();t.json(e)}catch(e){console.error("Error fetching users:",e),t.status(500).json({message:"Failed to fetch users"})}}),d.post("/api/events/:id/generate-feedback-link",async(s,t)=>{try{let e=parseInt(s.params.id),n=s.session.userId;if(!n)return t.status(401).json({message:"Unauthorized - Login Required"});console.log(`Verificando acesso para usu\xE1rio ${n} ao evento ${e}`);let r=await c.hasUserAccessToEvent(n,e);if(console.log(`Usu\xE1rio ${n} tem acesso ao evento ${e}:`,r),!r)return t.status(403).json({message:"Acesso negado ao evento"});let i=await c.generateFeedbackLink(e);console.log(`Link de feedback gerado para evento ${e}: ${i}`),t.json({feedbackUrl:i})}catch(e){console.error("Erro ao gerar link de feedback:",e),t.status(500).json({message:"Erro ao gerar link de feedback"})}}),d.get("/api/feedback/:feedbackId/event",async(s,t)=>{try{let{feedbackId:e}=s.params,n=await c.getEventByFeedbackId(e);if(!n)return t.status(404).json({message:"Link de feedback inv\xE1lido"});t.json({id:n.id,name:n.name,coverImageUrl:n.coverImageUrl,type:n.type})}catch(e){console.error("Erro ao buscar evento pelo feedbackId:",e),t.status(500).json({message:"Erro ao buscar informa\xE7\xF5es do evento"})}}),d.post("/api/feedback/:feedbackId",async(s,t)=>{try{let{feedbackId:e}=s.params,{name:n,email:r,rating:i,comment:l,isAnonymous:p}=s.body;if(!i||!l)return t.status(400).json({message:"Avalia\xE7\xE3o e coment\xE1rio s\xE3o obrigat\xF3rios"});if(i<1||i>5)return t.status(400).json({message:"Avalia\xE7\xE3o deve ser entre 1 e 5 estrelas"});let v=await c.getEventByFeedbackId(e);if(!v)return t.status(404).json({message:"Link de feedback inv\xE1lido"});let h=s.ip||s.connection.remoteAddress,w=s.get("User-Agent"),f=await c.createFeedback({eventId:v.id,feedbackId:e,name:p?null:n||null,email:p?null:r||null,rating:parseInt(i),comment:l,isAnonymous:p!==void 0?p:!0});try{await c.createFeedbackMetric({feedbackId:e,submittedAt:new Date,ipAddress:h,userAgent:w})}catch(k){console.error("Erro ao criar m\xE9trica de feedback:",k)}t.json({message:"Feedback enviado com sucesso!",feedback:{id:f.id,rating:f.rating,comment:f.comment,createdAt:f.createdAt}})}catch(e){console.error("Erro ao enviar feedback:",e),t.status(500).json({message:"Erro ao enviar feedback"})}}),d.get("/api/events/:id/feedbacks",async(s,t)=>{try{let e=parseInt(s.params.id),n=s.session.userId;if(!n)return t.status(401).json({message:"Unauthorized - Login Required"});console.log(`[DEBUG] Buscando feedbacks - EventId: ${e}, UserId: ${n}`);let r=await c.hasUserAccessToEvent(n,e);if(console.log(`[DEBUG] Usu\xE1rio ${n} tem acesso ao evento ${e}: ${r}`),!r)return t.status(403).json({message:"Acesso negado ao evento"});let i=await c.getEventFeedbacks(e);console.log(`[DEBUG] Retornando ${i.length} feedbacks para evento ${e}`),t.json(i)}catch(e){console.error("Erro ao buscar feedbacks:",e),t.status(500).json({message:"Erro ao buscar feedbacks"})}}),d.delete("/api/events/:eventId/feedbacks/:feedbackId",async(s,t)=>{try{let e=parseInt(s.params.eventId),n=parseInt(s.params.feedbackId),r=s.session.userId;if(!r)return t.status(401).json({message:"Unauthorized - Login Required"});if(!await c.hasUserAccessToEvent(r,e))return t.status(403).json({message:"Acesso negado ao evento"});await c.deleteFeedback(n),t.json({message:"Feedback exclu\xEDdo com sucesso"})}catch(e){console.error("Erro ao excluir feedback:",e),t.status(500).json({message:"Erro ao excluir feedback"})}}),d.get("/api/feedback/:feedbackId/event",async(s,t)=>{try{let{feedbackId:e}=s.params,n=await c.getEventByFeedbackId(e);if(!n)return t.status(404).json({message:"Link de feedback n\xE3o encontrado ou expirado"});try{let r=s.ip||s.connection.remoteAddress,i=s.get("User-Agent");await c.createFeedbackMetric({feedbackId:e,viewedAt:new Date,ipAddress:r,userAgent:i})}catch(r){console.error("Erro ao registrar m\xE9trica de visualiza\xE7\xE3o:",r)}t.json({id:n.id,name:n.name,type:n.type,coverImageUrl:n.coverImageUrl})}catch(e){console.error("Erro ao buscar informa\xE7\xF5es do evento para feedback:",e),t.status(500).json({message:"Erro interno do servidor"})}}),d.post("/api/events/:eventId/generate-feedback-link",E,async(s,t)=>{try{let e=parseInt(s.params.eventId),n=s.session.userId;console.log(`[DEBUG] Gerando link - EventId: ${e}, UserId: ${n}`);let r=n||s.user?.id;if(!r)return t.status(401).json({message:"Unauthorized - Login Required"});if(console.log(`[DEBUG] UserId final para gera\xE7\xE3o: ${r}`),!await c.hasUserAccessToEvent(r,e))return t.status(403).json({message:"Acesso negado ao evento"});let l=await c.generateFeedbackLink(e);t.json({feedbackUrl:l})}catch(e){console.error("Erro ao gerar link de feedback:",e),t.status(500).json({message:"Erro ao gerar link de feedback"})}}),d.get("/api/events/:eventId/feedback-link",async(s,t)=>{try{let e=parseInt(s.params.eventId),n=s.session.userId;if(!n)return t.status(401).json({message:"Unauthorized - Login Required"});if(console.log(`[DEBUG] Buscando link existente - EventId: ${e}, UserId: ${n}`),!await c.hasUserAccessToEvent(n,e))return t.status(403).json({message:"Acesso negado ao evento"});let i=await c.getExistingFeedbackLink(e);t.json({feedbackUrl:i||null})}catch(e){console.error("Erro ao buscar link de feedback:",e),t.status(500).json({message:"Erro ao buscar link de feedback"})}}),y}var me=xe();me.use(xe.json({limit:"50mb"}));me.use(xe.urlencoded({extended:!1,limit:"50mb"}));me.use((d,a,o)=>{let u=Date.now(),m=d.path,y,s=a.json;a.json=function(t,...e){return y=t,s.apply(a,[t,...e])},a.on("finish",()=>{let t=Date.now()-u;if(m.startsWith("/api")){let e=`${d.method} ${m} ${a.statusCode} in ${t}ms`;y&&(e+=` :: ${JSON.stringify(y)}`),e.length>80&&(e=e.slice(0,79)+"\u2026"),console.log(e)}}),o()});var ze=!1,kt=Ce(me).then(()=>{me.use((d,a,o,u)=>{let m=d.status||d.statusCode||500,y=d.message||"Internal Server Error";o.status(m).json({message:y})}),ze=!0,console.log("Routes initialized successfully")}).catch(d=>{console.error("Failed to initialize routes:",d)}),Dt=async(d,a)=>(ze||await kt,me(d,a)),Cs=Dt;export{Cs as default};
